<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.8.2. USB WEBCAM常见问题(FAQ) &mdash; X3 用户手册 1.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/horizon_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/horizon.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/hobot.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="8.9. 量化工具链类" href="../ai_toolchain_faqs/index.html" />
    <link rel="prev" title="8.8.1. USB常见问题(FAQ)" href="USB_COMMON_FAQs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> X3 用户手册
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.html">1. 前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start/index.html">2. 快速入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">3. Demo使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsp_develop/index.html">4. BSP开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mpp_develop/index.html">5. 多媒体开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ai_toolchain_develop/index.html">6. 量化工具链开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pc_tools/index.html">7. PC工具使用指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">8. FAQ</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html">8.1. 环境类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html#id3">8.2. 系统类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html#id8">8.3. 视频处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html#id12">8.4. 编解码类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html#id14">8.5. 外设类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html#id15">8.6. 硬件类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQs.html#id19">8.7. 工具类</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">8.8. 总线类</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="USB_COMMON_FAQs.html">8.8.1. USB常见问题(FAQ)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.8.2. USB WEBCAM常见问题(FAQ)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#usb-webcam">8.8.2.1. 如何使用usb_webcam单元测试程序?</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id1">例子:</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id2">8.8.2.2. 程序脚本的详细内容?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#isoc-bulkuvc">8.8.2.3. 如何区分isoc, bulk传输两种类型的uvc程序?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usb-webcamsensor">8.8.2.4. usb_webcam程序的sensor配置和选择?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">8.8.2.5. usb_webcam 相关复合设备典型形态如何运行?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uac2-windows">8.8.2.6. uac2 windows设备如何配置?(废弃)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uvc">8.8.2.7. 如何修改uvc摄像头支持的格式和分辨率?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uac">8.8.2.8. 如何修改uac设备的音频采样率和频道数?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uac-win10">8.8.2.9. 修改uac设备采样率, 通道等配置后, win10平台无法打开问题?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uvc-isoc">8.8.2.10. uvc isoc传输多带宽配置相关?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">8.8.2.11. uvc isoc传输性能方面问题汇总?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ai_toolchain_faqs/index.html">8.9. 量化工具链类</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../feedback.html">9. 建议反馈</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">X3 用户手册</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html"><span class="section-number">8. </span>FAQ</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">8.8. </span>总线类</a> &raquo;</li>
      <li><span class="section-number">8.8.2. </span>USB WEBCAM常见问题(FAQ)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="USB_COMMON_FAQs.html" class="btn btn-neutral float-left" title="8.8.1. USB常见问题(FAQ)" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../ai_toolchain_faqs/index.html" class="btn btn-neutral float-right" title="8.9. 量化工具链类" accesskey="n">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="usb-webcam-faq">
<h1><span class="section-number">8.8.2. </span>USB WEBCAM常见问题(FAQ)<a class="headerlink" href="#usb-webcam-faq" title="永久链接至标题"></a></h1>
<section id="usb-webcam">
<h2><span class="section-number">8.8.2.1. </span>如何使用usb_webcam单元测试程序?<a class="headerlink" href="#usb-webcam" title="永久链接至标题"></a></h2>
<ul class="simple">
<li><p>驱动: usb-gadget.sh</p></li>
<li><p>程序：usb_webcam</p></li>
</ul>
<section id="id1">
<h3>例子:<a class="headerlink" href="#id1" title="永久链接至标题"></a></h3>
<ul>
<li><p>usb2.0/3.0 isoc模式 uvc</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/etc/init.d/usb-gadget.sh start uvc isoc	<span class="c1"># usb2.0/3.0 isoc模式 uvc-gadget驱动</span>
usb_webcam -e <span class="m">0</span> -m <span class="m">2</span> -t <span class="m">10</span>			<span class="c1"># 1080p test pattern</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/etc/init.d/usb-gadget.sh start uvc isoc
usb_webcam -e <span class="m">2</span> -m <span class="m">2</span> -t <span class="m">10</span>			<span class="c1"># 4k test pattern</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/etc/init.d/usb-gadget.sh start uvc isoc
usb_webcam -e <span class="m">5</span> -m <span class="m">2</span> -t <span class="m">10</span>			<span class="c1"># 0s8a10 sensor</span>
</pre></div>
</div>
</li>
<li><p>usb2.0/3.0 bulk模式 uvc</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/etc/init.d/usb-gadget.sh start uvc		<span class="c1"># usb2.0/3.0 bulk模式 uvc-gadget驱动</span>
usb_webcam -e <span class="m">0</span> -t <span class="m">9</span> -b			<span class="c1"># 1080p test pattern</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/etc/init.d/usb-gadget.sh start uvc
usb_webcam -e <span class="m">2</span> -t <span class="m">9</span> -b			<span class="c1"># 4k test pattern</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/etc/init.d/usb-gadget.sh start uvc
usb_webcam -e <span class="m">5</span> -t <span class="m">9</span> -b			<span class="c1"># os8a10 sensor</span>
</pre></div>
</div>
</li>
<li><p>主机端(如PC)运行potplayer, amcap, 相机等各种程序选择合适分辨率播放即可</p></li>
</ul>
</section>
</section>
<section id="id2">
<h2><span class="section-number">8.8.2.2. </span>程序脚本的详细内容?<a class="headerlink" href="#id2" title="永久链接至标题"></a></h2>
<p>请参考/etc/init.d/usb-gadget.sh和/usr/bin/usb_webcam.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>文件名</th>
<th>源码路径</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>usb-gadget.sh</td>
<td>prebuilts/root_hijack/usb/gadget</td>
<td>利用configfs文件系统加载usb-gadget驱动.</td>
</tr>
<tr>
<td>usb_webcam</td>
<td>hbre/libhapi/sample/usb/gadget/usb_webcam</td>
<td>应用程序</td>
</tr>
<tr>
<td></td>
<td>hbre/libhapi/sample/usb/gadget/libguvc</td>
<td>动态库</td>
</tr>
</tbody>
</table><p>详细使用方法请参考help说明</p>
<ul class="simple">
<li><p>usb-gadget.sh脚本</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root@x3sdbx3-hynix1G-2666:~# /etc/init.d/usb-gadget.sh
Detecting platform:
 board : Hobot XJ3 SOC SDB
 udc   : b2000000.dwc3
Usage: /etc/init.d/usb-gadget.sh <span class="o">{</span>start<span class="p">|</span>stop<span class="p">|</span>restart<span class="o">}</span> <span class="o">[</span>options<span class="o">]</span>
 options:
 detail gadget-composite config, using .usb/.default-config <span class="k">in</span> default
      adb                         launch adbd
      msd                         run as gadget mass storage device
      hid                         run as hid gadget
      rndis                       run as rndis gadget
      ecm                         run as cdc ether gadget
      uvc                         run as uvc gadget
      uac1                        usb audio class specification <span class="m">1</span>
      uac2                        usb audio class specification <span class="m">2</span>
      uvc-hid                     uvc + hid composite gadget
      uvc-uac1                    uvc + uac1 composite gadget
      uvc-uac2                    uvc + uac2 composite gadget
      uvc-hid-uac1                uvc + hid + uac1 composite gadget
      uvc-hid-uac2                uvc + hid + uac2 composite gadget
      uvc-rndis                   uvc + rndis composite gadget
      uvc-ecm                     uvc + cdc ether composite gadget
      uvc-acm                     uvc + acm<span class="o">(</span>serial<span class="o">)</span> composite gadget
      uvc-rndis-uac1              uvc + rndis + uac1 composite gadget
      uvc-rndis-uac2              uvc + rndis + uac2 composite gadget
      uvc-ecm-uac1                uvc + ecm + uac1 composite gadget
      uvc-ecm-uac2                uvc + ecm + uac2 composite gadget
      rndis-hid                   rndis + hid composite gadget
      rndis-uac1                  rndis + uac1 composite gadget
      msd-uac1                    msd + uac1 composite gadget
      hid-uac1                    hid + uac1 composite gadget
      uvc-adb                     uvc + adb composite gadget
</pre></div>
</div>
<ul class="simple">
<li><p>usb_webcam程序</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root@x3sdbx3-hynix1G-2666:~# usb_webcam -h
Usage: usb_webcam <span class="o">[</span>options<span class="o">]</span>
Available options are
 -b             Use bulk mode
 -a             use streaming multi alternate setting
 -e &lt;mipi_sensor_type&gt; Just refer to mipi_sensor_type enum
        <span class="nv">0</span> <span class="o">=</span> 4M <span class="nb">test</span> pattern
        <span class="nv">2</span> <span class="o">=</span> 12M <span class="nb">test</span> pattern
        <span class="nv">3</span> <span class="o">=</span> 8M<span class="o">(</span>4k<span class="o">)</span> <span class="nb">test</span> pattern
        <span class="nv">5</span> <span class="o">=</span> os8a10
        <span class="nv">11</span> <span class="o">=</span> f37
        <span class="nv">12</span> <span class="o">=</span> imx307
        <span class="nv">13</span> <span class="o">=</span> ar0233
 -m             Streaming mult <span class="k">for</span> ISOC <span class="o">(</span>b/w <span class="m">0</span> and <span class="m">2</span><span class="o">)</span>
 -t             Streaming burst <span class="o">(</span>b/w <span class="m">0</span> and <span class="m">15</span><span class="o">)</span>
 -p             Max packet size bytes <span class="k">for</span> ISOC <span class="o">(</span><span class="m">0</span>-3072<span class="o">)</span>
 -s &lt;speed&gt;     Select USB bus speed <span class="o">(</span>b/w <span class="m">0</span> and <span class="m">2</span><span class="o">)</span>
        <span class="nv">2</span> <span class="o">=</span> Full Speed <span class="o">(</span>FS<span class="o">)</span>
        <span class="nv">3</span> <span class="o">=</span> High Speed <span class="o">(</span>HS<span class="o">)</span>
        <span class="nv">5</span> <span class="o">=</span> Super Speed <span class="o">(</span>SS<span class="o">)</span>
        ? <span class="o">=</span> Super Speed <span class="o">(</span>SS<span class="o">)</span>
 -n             Number of Video buffers <span class="o">(</span>b/w <span class="m">2</span> and <span class="m">32</span><span class="o">)</span>
root@x3sdbx3-hynix1G-2666:~#
</pre></div>
</div>
</section>
<section id="isoc-bulkuvc">
<h2><span class="section-number">8.8.2.3. </span>如何区分isoc, bulk传输两种类型的uvc程序?<a class="headerlink" href="#isoc-bulkuvc" title="永久链接至标题"></a></h2>
<p>例子:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># usb2.0/3.0 isoc模式 uvc</span>
/etc/init.d/usb-gadget.sh start uvc isoc
usb_webcam -e <span class="m">2</span> -m <span class="m">2</span> -t <span class="m">10</span>			<span class="c1"># 4k test pattern</span>
usb_webcam -e <span class="m">5</span> -m <span class="m">2</span> -t <span class="m">10</span>			<span class="c1"># 0s8a10 sensor</span>

<span class="c1"># usb2.0/3.0 bulk模式 uvc</span>
/etc/init.d/usb-gadget.sh start uvc
usb_webcam -e <span class="m">0</span> -t <span class="m">9</span> -b				<span class="c1"># 1080p test pattern</span>
usb_webcam -e <span class="m">2</span> -t <span class="m">9</span> -b				<span class="c1"># 4k test pattern</span>
usb_webcam -e <span class="m">5</span> -t <span class="m">9</span> -b				<span class="c1"># os8a10 sensor</span>
</pre></div>
</div>
<p>即usb-gadget.sh驱动加载uvc时有isoc结尾为isoc等时传输模式, 否则默认为bulk模式.<br />应用程序也需要区分isoc和bulk模式.<br />usb_webcam程序利用-b参数区分.</p>
</section>
<section id="usb-webcamsensor">
<h2><span class="section-number">8.8.2.4. </span>usb_webcam程序的sensor配置和选择?<a class="headerlink" href="#usb-webcamsensor" title="永久链接至标题"></a></h2>
<p>可参考/etc/usb_webcam.conf, 并且根据实际连线方式, 以及sensor类型进行相应配置.</p>
<p>usb_webcam 程序的 -e 选项最终选择对应摄像头.</p>
<ul>
<li><p>参考usb_webcam -h help说明如下</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root@x3sdbx3-hynix1G-2666:~# usb_webcam -h
Usage: usb_webcam <span class="o">[</span>options<span class="o">]</span>
Available options are
 -b             Use bulk mode
 -a             use streaming multi alternate setting
 -e &lt;mipi_sensor_type&gt; Just refer to mipi_sensor_type enum
        <span class="nv">0</span> <span class="o">=</span> 4M <span class="nb">test</span> pattern
        <span class="nv">2</span> <span class="o">=</span> 12M <span class="nb">test</span> pattern
        <span class="nv">3</span> <span class="o">=</span> 8M<span class="o">(</span>4k<span class="o">)</span> <span class="nb">test</span> pattern
        <span class="nv">5</span> <span class="o">=</span> os8a10
        <span class="nv">11</span> <span class="o">=</span> f37
        <span class="nv">12</span> <span class="o">=</span> imx307
        <span class="nv">13</span> <span class="o">=</span> ar0233
......
</pre></div>
</div>
</li>
<li><p>具体sensor配置(如i2c总线号等)请修改/etc/usb_webcam.conf配置文件.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root@x3dvbx3-samsung2G-2666:~# cat /etc/usb_webcam.conf
<span class="c1"># usb_webcam user params</span>
<span class="c1">#</span>
<span class="c1">######################################################</span>
<span class="c1">#                 test pattern 1080p                 #</span>
<span class="c1">######################################################</span>
<span class="o">[</span>pattern@1080p<span class="o">]</span>

<span class="c1"># value</span>
<span class="nv">format</span> <span class="o">=</span> nv12
<span class="nv">width</span> <span class="o">=</span> <span class="m">1920</span>
<span class="nv">height</span> <span class="o">=</span> <span class="m">1080</span>
<span class="nv">req_width</span> <span class="o">=</span> <span class="m">1920</span>
<span class="nv">req_height</span> <span class="o">=</span> <span class="m">1080</span>
<span class="nv">pipe_id_mask</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">pipe_id_using</span> <span class="o">=</span> <span class="m">0</span>
<span class="nv">need_clk</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">use_pattern</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">pattern_fps</span> <span class="o">=</span> <span class="m">30</span>
<span class="nv">pym_mask</span> <span class="o">=</span> <span class="m">64</span>
<span class="nv">ipu_mask</span> <span class="o">=</span> <span class="m">64</span>
<span class="nv">has_venc</span> <span class="o">=</span> <span class="m">0</span>

<span class="c1"># list</span>
<span class="nv">sensor_id</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">mipi_idx</span> <span class="o">=</span> <span class="m">1</span>,
<span class="nv">bus_idx</span> <span class="o">=</span> <span class="m">5</span>,
<span class="nv">port_idx</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">serdes_idx</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">serdes_port</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">vin_vps_mode</span> <span class="o">=</span> <span class="m">0</span>,


<span class="c1">######################################################</span>
<span class="c1">#                 OS8A10 sensor                      #</span>
<span class="c1">######################################################</span>
<span class="o">[</span>os8a10<span class="o">]</span>

<span class="c1"># value</span>
<span class="nv">format</span> <span class="o">=</span> nv12
<span class="nv">width</span> <span class="o">=</span> <span class="m">1920</span>
<span class="nv">height</span> <span class="o">=</span> <span class="m">1080</span>
<span class="nv">req_width</span> <span class="o">=</span> <span class="m">1920</span>
<span class="nv">req_height</span> <span class="o">=</span> <span class="m">1080</span>
<span class="nv">pipe_id_mask</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">pipe_id_using</span> <span class="o">=</span> <span class="m">0</span>
<span class="nv">need_clk</span> <span class="o">=</span> <span class="m">1</span>
<span class="nv">use_pattern</span> <span class="o">=</span> <span class="m">0</span>
<span class="nv">pattern_fps</span> <span class="o">=</span> <span class="m">30</span>
<span class="nv">pym_mask</span> <span class="o">=</span> <span class="m">64</span>
<span class="nv">ipu_mask</span> <span class="o">=</span> <span class="m">64</span>
<span class="nv">has_venc</span> <span class="o">=</span> <span class="m">0</span>

<span class="c1"># list</span>
<span class="nv">sensor_id</span> <span class="o">=</span> <span class="m">5</span>,
<span class="nv">mipi_idx</span> <span class="o">=</span> <span class="m">1</span>,
<span class="nv">bus_idx</span> <span class="o">=</span> <span class="m">5</span>,
<span class="nv">port_idx</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">serdes_idx</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">serdes_port</span> <span class="o">=</span> <span class="m">0</span>,
<span class="nv">vin_vps_mode</span> <span class="o">=</span> <span class="m">0</span>,
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id3">
<h2><span class="section-number">8.8.2.5. </span>usb_webcam 相关复合设备典型形态如何运行?<a class="headerlink" href="#id3" title="永久链接至标题"></a></h2>
<p>以uvc + uac2 + rndis webcam为例子, x3 dvb开发板 接好 音频子板环境,</p>
<p>可直接执行脚本 /usr/bin/uvc-uac2-rndis.sh</p>
<p>或根据实际环境, 参考并修改相应的sensor, 前端声卡驱动等.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># insmod alsa driver</span>
modprobe ac108_driver
modprobe ac101
modprobe hobot-dma
modprobe hobot-cpudai <span class="nv">i2s_ms</span><span class="o">=</span><span class="m">1</span>
modprobe hobot-snd-96 <span class="nv">snd_card</span><span class="o">=</span><span class="m">0</span>

<span class="c1"># launch uvc + uac2 + rndis driver in isoc mode</span>
service adbd stop
/etc/init.d/usb-gadget.sh start uvc-rndis-uac2 isoc

<span class="c1"># config usb0 ip address</span>
ifconfig usb0 <span class="m">192</span>.168.100.100

<span class="c1"># audio application</span>
uac-gadget --only-uac-micphone <span class="p">&amp;</span>

<span class="c1"># usb2.0/3.0 isoc mode uvc gadget</span>
usb_webcam -e <span class="m">3</span> -m <span class="m">2</span> -t <span class="m">10</span>
</pre></div>
</div>
<p>目前uvc, rndis, uac2在win10上都能自动加载微软自带驱动,
故无需手动加载特殊驱动了。</p>
<p>PC 端可运行飞书, 企业微信, potplayer等软件进行音视频测试。</p>
<p>网络端可以利用ping, iperf程序进行测试。</p>
</section>
<section id="uac2-windows">
<h2><span class="section-number">8.8.2.6. </span>uac2 windows设备如何配置?(废弃)<a class="headerlink" href="#uac2-windows" title="永久链接至标题"></a></h2>
<ul>
<li><p><strong>最新软件包uac2可以支持win10默认驱动了, 无需手动选择设备了</strong></p>
  <details>
  <summary>
  如果用的是较老的软件包, 可参考本章节.
  </summary>
  针对uvc + uac2 + rndis的复杂复合设备, 目前我们配置的uac只有单通道输入模式,
  即只是一个usb audio麦克风/录音设备。<p>目前win10上设备枚举后是一个source/sink设备</p>
<p><img alt="Generated" src="../../_images/984568e59d811e32d30f738c5d3c1610.png" /></p>
<p>但是音频输入和输出设备中并没有出现对应的音频设备。需右键点击右下角声音标志,
进入声音设置选项, 如下图:</p>
<p><img alt="Generated" src="../../_images/e458f060aa82bf4eb75c117481dd8655.png" /></p>
<p>内部AUX插座启用后就出现了音频设备。</p>
<p><img alt="Generated" src="../../_images/81866c0bac00177bed7ec3b21864e5cf.png" /></p>
<p>然后就可以利用audacity, 飞书, 企业微信, potplayer程序进行验证。</p>
  </details></li>
</ul>
</section>
<section id="uvc">
<h2><span class="section-number">8.8.2.7. </span>如何修改uvc摄像头支持的格式和分辨率?<a class="headerlink" href="#uvc" title="永久链接至标题"></a></h2>
<p>目前代码需要修改两处地方, 可在以下两处添加, 删除对应分辨率, 注意需保持匹配。</p>
<ol>
<li><p>prebuilts/root_hijack/usb/gadget/usb-gadget.sh
的create_uvc和delete_uvc函数处,</p>
<p><img alt="Generated" src="../../_images/1f15c0335d59e4a3a3bab8dd309c04a0.png" /></p>
</li>
<li><p>hbre/libhapi/sample/usb/gadget/libguvc/src/uvc_gadget.c处</p>
<p><img alt="Generated" src="../../_images/10f4eb9c728578a3a28d37aac83be11d.png" /></p>
</li>
</ol>
</section>
<section id="uac">
<h2><span class="section-number">8.8.2.8. </span>如何修改uac设备的音频采样率和频道数?<a class="headerlink" href="#uac" title="永久链接至标题"></a></h2>
<p>可修改 /etc/init.d/usb-gadget.sh 的create_uac2处,</p>
<p>最终修改/sys/kernel/config/usb_gadget/g_comp/functions/uac2.0中的相关参数。</p>
<p><img alt="Generated" src="../../_images/86db412439edb8637d1a227966d4f6bd.png" /></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root@x3dvbx3-samsung2G-2666:/sys/kernel/config/usb_gadget/g_comp/functions/uac2.0# ls -all
drwxr-xr-x    <span class="m">2</span> root     root             <span class="m">0</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 .
drwxr-xr-x    <span class="m">3</span> root     root             <span class="m">0</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 ..
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 c_chmask
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 c_srate
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 c_ssize
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 p_chmask
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 p_srate
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 p_ssize
-rw-r--r--    <span class="m">1</span> root     root          <span class="m">4096</span> Jan  <span class="m">1</span> <span class="m">08</span>:05 req_number
root@x3dvbx3-samsung2G-2666:/sys/kernel/config/usb_gadget/g_comp/functions/uac2.0# cat p_chmask
<span class="m">3</span>
root@x3dvbx3-samsung2G-2666:/sys/kernel/config/usb_gadget/g_comp/functions/uac2.0# cat p_srate
<span class="m">48000</span>
root@x3dvbx3-samsung2G-2666:/sys/kernel/config/usb_gadget/g_comp/functions/uac2.0# cat p_ssize
<span class="m">2</span>
</pre></div>
</div>
<p>例如:</p>
<ul class="simple">
<li><p>只做uac micphone设备 (即只有uac 单向playback, x3m-&gt;PC)</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> 0x3 &gt; functions/<span class="nv">$FUNCTION</span>/p_chmask             <span class="c1"># 双通道</span>
<span class="nb">echo</span> <span class="m">48000</span> &gt; functions/<span class="nv">$FUNCTION</span>/p_srate            <span class="c1"># 48khz采样率 </span>

<span class="nb">echo</span> <span class="m">0</span> &gt; functions/<span class="nv">$FUNCTION</span>/c_chmask               <span class="c1"># 将capture通道声道数设置为0, 则没有PC-&gt;X3的通道</span>
</pre></div>
</div>
<ul class="simple">
<li><p>做uac micphone/speaker双向设备</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> 0x3 &gt; functions/<span class="nv">$FUNCTION</span>/p_chmask             <span class="c1"># x3-&gt;PC playback双通道</span>
<span class="nb">echo</span> <span class="m">16000</span> &gt; functions/<span class="nv">$FUNCTION</span>/p_srate            <span class="c1"># 16khz采样率</span>

<span class="nb">echo</span> <span class="nb">echo</span> 0x3 &gt; functions/<span class="nv">$FUNCTION</span>/c_chmask        <span class="c1"># PC-&gt;x3 capture双通道</span>
<span class="nb">echo</span> <span class="m">16000</span> &gt; functions/<span class="nv">$FUNCTION</span>/c_srate            <span class="c1"># 16khz采样率</span>
</pre></div>
</div>
</section>
<section id="uac-win10">
<h2><span class="section-number">8.8.2.9. </span>修改uac设备采样率, 通道等配置后, win10平台无法打开问题?<a class="headerlink" href="#uac-win10" title="永久链接至标题"></a></h2>
<p>win10平台有驱动记忆功能, 即usb设备如果vid, pid未发生变化的话, 就算采样率,
通道数等信息发生变化, win10依旧会采用之前的驱动,
不会重新加载驱动。故导致按上述item修改完配置的uac设备, win10 Potplayer,
audacity等软件无法打开。<br />ubuntu等电脑没有该问题。</p>
<p>解决方法:</p>
<ul class="simple">
<li><p>通过设备管理器卸载x3m对应设备 (通过详细信息-&gt;硬件id等信息找到x3设备,
通过usb-gadget.sh启动的是01db/0104)</p></li>
</ul>
<p><img alt="Generated" src="../../_images/e2df18ea506947ea1565cb80da733053.jpg" /></p>
<ul class="simple">
<li><p>然后右键点击扫描检测硬件改动, 则会重新加载uac设备驱动。 (或者热插拔也可以。)</p></li>
</ul>
<p><img alt="Generated" src="../../_images/d8ad0b6f2b89ae25ea3c23a0386398d7.jpg" /></p>
<ul class="simple">
<li><p>通过电脑桌面右下角音量-&gt;右键-&gt;声音-&gt;录制-&gt;属性-&gt;高级
可查看默认格式是否正确, 如果没有高级选项, 则说明驱动未重新加载,
后续potplayer等软件打开会失败或卡住。</p></li>
</ul>
<p><img alt="Generated" src="../../_images/831e11969beee9554b8722dfc8ea63a4.jpg" /></p>
<p>*注: sdb开发板热插拔会切换usb主从模式,
rel-br22分支代码uac2部分有bug导致热插拔后枚举失败问题.
可卸载extcon-usb-gpio驱动, 移除otg功能, 让sdb板子保持在设备端, 则没有该bug.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> soc:usb-id &gt; /sys/bus/platform/drivers/extcon-usb-gpio/unbind
</pre></div>
</div>
</section>
<section id="uvc-isoc">
<h2><span class="section-number">8.8.2.10. </span>uvc isoc传输多带宽配置相关?<a class="headerlink" href="#uvc-isoc" title="永久链接至标题"></a></h2>
<p>Linux主线代码关于uvc isoc模式只实现了 alt 0 - zero bandwidth, alt 1 - full
bandwidth两种带宽配置,</p>
<p>实际成品摄像头通常根据各种分辨率提供不同的带宽配置,
以保证数据负载能相对均匀地分布在usb等时传输的微帧中。以做到名副其实的等时传输。</p>
<p>主线最新代码已经实现了这套机制,</p>
<p>内核态patch请参考 commit a1426bf90fd504c3897fd587f4a91d6db6a5e422</p>
<p>用户态patch请参考 commit ebf21f479c0bea271cbf106432bd0494041985a8</p>
<p>目前代码已实现了nv12, yuy2, mjpeg三种格式的多带宽配置方案,
h264由于本身码率变化更大, 故依然采用了 空/满带宽两种配置方式。</p>
<p>客户如果修改mjpeg的编码质量等参数, 导致相应的带宽配置不匹配,
可以手动修改用户态程序</p>
<p>hbre/libhapi/sample/usb/gadget/libguvc/src/uvc_gadget.c 进行max pakcket
size的修改。</p>
<p><img alt="Generated" src="../../_images/e44a7aef27790f57d6de590ce8960684.png" /></p>
<ul class="simple">
<li><p>注:
max_packet_size请参考内核drivers/usb/gadget/function/f_uvc.c中的isoc_max_packet_size值进行修改。如需添加或修改一些其他值，
需内核和用户态程序共同修改。</p></li>
</ul>
<p><img alt="Generated" src="../../_images/3f606a1fb309354763053a7614d0194b.png" /></p>
</section>
<section id="id4">
<h2><span class="section-number">8.8.2.11. </span>uvc isoc传输性能方面问题汇总?<a class="headerlink" href="#id4" title="永久链接至标题"></a></h2>
<p>usb isoc传输是一种注重实时性, 不注重数据完整性的传输协议。 类似udp,
isoc传输没有数据出错重传机制。故设备端中断处理,
数据传输等性能方面会影响到isoc传输的数据完整性。</p>
<p>对于h264, mjpeg等压缩数据来说, isoc传输的丢帧策略就会导致图像花屏, 撕裂等现象。</p>
<p>常见的丢数据场景有</p>
<ul class="simple">
<li><p>系统负载过高, 线程和中断处理繁忙, 导致设备端发数据给usb控制器慢了,
dwc3控制器发现数据带的微帧号已经过期了, 则会丢弃该帧数据。报-18 (Missed
Isoc)错误。</p></li>
<li><p>usb控制器axi总线优先级低, 导致dma从ddr上搬运数据的效率过低,
最终导致数据超时被丢弃。</p></li>
<li><p>usb信号质量不行(眼图没过), 导致usb总线上数据出错, 主机端虽然会做crc校验,
但没有重传机制, 导致花屏现象产生。</p></li>
</ul>
<p>总结有如下一些方式提高usb模块的性能:</p>
<ol>
<li><p>将usb中断单独绑定到其他cpu核心上, 避免都在cpu0上中断竞争。</p>
<p>cat /proc/interrupts         # 找到dwc3的中断号(我的系统中是178)</p>
<p><img alt="Generated" src="../../_images/9dc276bb40db62711ec9b24087844edc.png" /></p>
<p>echo 8 &gt; /proc/irq/178/smp_affinity   # 将dwc3的中断绑定在cpu 核心4上</p>
</li>
<li><p>用户态进程绑到其他空闲核心上</p></li>
<li><p>ddr qos调整usb模块访问的优先级</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat /sys/bus/platform/drivers/ddr_monitor/write_qos_ctrl/peri
cat /sys/bus/platform/drivers/ddr_monitor/read_qos_ctrl/peri

<span class="nb">echo</span> <span class="m">15</span> &gt; /sys/bus/platform/drivers/ddr_monitor/write_qos_ctrl/peri
<span class="nb">echo</span> <span class="m">15</span> &gt; /sys/bus/platform/drivers/ddr_monitor/read_qos_ctrl/peri
</pre></div>
</div>
</li>
<li><p>调整cpu频率到performance模式</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> performance &gt; /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
</pre></div>
</div>
</li>
<li><p>调高ddr到更高的稳定频率(比如3200MHz, 4266MHz)</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="USB_COMMON_FAQs.html" class="btn btn-neutral float-left" title="8.8.1. USB常见问题(FAQ)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../ai_toolchain_faqs/index.html" class="btn btn-neutral float-right" title="8.9. 量化工具链类" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, Horizon Robotics.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>