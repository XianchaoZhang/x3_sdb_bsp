<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6.3. 快速体验 &mdash; X3 用户手册 1.0.1 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/horizon_theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/horizon.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/hobot.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="6.4. 训练后量化(PTQ)使用说明" href="horizon_ai_toolchain_user_guide/index.html" />
    <link rel="prev" title="6.2. 环境安装" href="env_install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> X3 用户手册
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface/index.html">1. 前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">2. 快速入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../samples/index.html">3. Demo使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bsp_develop/index.html">4. BSP开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mpp_develop/index.html">5. 多媒体开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">6. 量化工具链开发指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="preface_toolchain_overview.html">6.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_install.html">6.2. 环境安装</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.3. 快速体验</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">6.3.1. 开发环境准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">6.3.2. 模型准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">6.3.3. 模型验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">6.3.4. 模型转换</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">6.3.5. 模型性能验证</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">6.3.5.1. 静态性能评估</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">6.3.5.2. 动态性能评估</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id9">6.3.6. 模型精度验证</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python">6.3.6.1. 开发机Python环境验证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c">6.3.6.2. 开发板C++环境验证</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">6.3.7. 公版模型性能精度指标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="horizon_ai_toolchain_user_guide/index.html">6.4. 训练后量化(PTQ)使用说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="horizon_runtime_samples/index.html">6.5. 上板运行(runtime)应用开发说明</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pc_tools/index.html">7. PC工具使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQs/index.html">8. FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feedback.html">9. 建议反馈</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">X3 用户手册</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">6. </span>量化工具链开发指南</a> &raquo;</li>
      <li><span class="section-number">6.3. </span>快速体验</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="env_install.html" class="btn btn-neutral float-left" title="6.2. 环境安装" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="horizon_ai_toolchain_user_guide/index.html" class="btn btn-neutral float-right" title="6.4. 训练后量化(PTQ)使用说明" accesskey="n">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><span class="section-number">6.3. </span>快速体验<a class="headerlink" href="#id1" title="永久链接至标题"></a></h1>
<p>本章节中，我们为您介绍量化工具链PTQ方案的基本使用流程，便于您实现快速上手。 这里我们以 MobileNet-v1 模型为例，为您进行使用演示，量化工具链PTQ方案的更多详细内容，请阅读 <a class="reference external" href="./horizon_ai_toolchain_user_guide/ptq_user_guide/index.html">PTQ原理及步骤详解</a> 章节。</p>
<section id="id2">
<h2><span class="section-number">6.3.1. </span>开发环境准备<a class="headerlink" href="#id2" title="永久链接至标题"></a></h2>
<p>开发环境准备包括开发机host端（用于模型转换）和开发板board端（用于模型部署），若未准备开发环境，请阅读 <a class="reference external" href="./env_install.html">环境安装</a> 章节进行环境安装。</p>
</section>
<section id="id3">
<h2><span class="section-number">6.3.2. </span>模型准备<a class="headerlink" href="#id3" title="永久链接至标题"></a></h2>
<p>若开发环境已准备完成，请根据 <a class="reference external" href="./env_install.html#docker">使用Docker环境</a> 章节介绍的方法，进入开发机模型转换环境中。</p>
<p>执行以下命令，检查MobileNet-v1浮点模型是否存在：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    ls -l model_zoo/mapper/classification/mobilenet
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志，说明模型已准备完成：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="o">[</span>root@e99c47d29bdf open_explorer<span class="o">]</span><span class="c1"># ls -l model_zoo/mapper/classification/mobilenet</span>
    total <span class="m">30564</span>
    -rw-r--r-- <span class="m">1</span> <span class="m">10488</span> <span class="m">10501</span> <span class="m">17027058</span> Aug  <span class="m">8</span> <span class="m">22</span>:01 mobilenet.caffemodel
    -rw-r--r-- <span class="m">1</span> <span class="m">10488</span> <span class="m">10501</span>    <span class="m">28105</span> Aug  <span class="m">8</span> <span class="m">22</span>:01 mobilenet_deploy.prototxt
    -rw-r--r-- <span class="m">1</span> <span class="m">10488</span> <span class="m">10501</span> <span class="m">14186496</span> Aug  <span class="m">8</span> <span class="m">22</span>:01 mobilenet_v2.caffemodel
    -rw-r--r-- <span class="m">1</span> <span class="m">10488</span> <span class="m">10501</span>    <span class="m">51551</span> Aug  <span class="m">8</span> <span class="m">22</span>:01 mobilenet_v2_deploy.prototxt
</pre></div>
</div>
<p>若执行命令后，未出现以上日志，请阅读 <a class="reference external" href="./env_install.html#id2">交付物说明</a> 章节，进行模型示例包model_zoo的获取。</p>
</section>
<section id="id4">
<h2><span class="section-number">6.3.3. </span>模型验证<a class="headerlink" href="#id4" title="永久链接至标题"></a></h2>
<p>若示例浮点模型已准备完成，使用 <code class="docutils literal notranslate"><span class="pre">hb_mapper</span> <span class="pre">checker</span></code> 工具进行模型验证，确保其符合地平线X3芯片的支持约束。</p>
<ul class="simple">
<li><p>进入浮点模型转换示例MobileNet-v1模型目录</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="nb">cd</span> ai_toolchain/horizon_model_convert_sample/03_classification/01_mobilenet/mapper
</pre></div>
</div>
<ul class="simple">
<li><p>模型检查</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="c1">#确认模型结构及算子是否支持，并提供每个算子执行硬件的分配情况（BPU/CPU）</span>
    bash 01_check.sh
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志，说明模型校验成功</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="m">2022</span>-12-07 <span class="m">17</span>:48:06,428 INFO <span class="o">[</span>Wed Dec  <span class="m">7</span> <span class="m">17</span>:48:06 <span class="m">2022</span><span class="o">]</span> End to Horizon NN Model Convert.
    <span class="m">2022</span>-12-07 <span class="m">17</span>:48:06,451 INFO ONNX model output num : <span class="m">3</span>
    <span class="m">2022</span>-12-07 <span class="m">17</span>:48:06,473 INFO End model checking....
</pre></div>
</div>
</section>
<section id="id5">
<h2><span class="section-number">6.3.4. </span>模型转换<a class="headerlink" href="#id5" title="永久链接至标题"></a></h2>
<p>模型检查通过后，请使用 <code class="docutils literal notranslate"><span class="pre">hb_mapper</span> <span class="pre">makertbin</span></code> 工具进行模型转换。</p>
<ul class="simple">
<li><p>进行校准数据预处理</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    bash 02_preprocess.sh
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明数据预处理成功</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    write:./calibration_data_bgr_f32/ILSVRC2012_val_00000098.bgr
    write:./calibration_data_bgr_f32/ILSVRC2012_val_00000099.bgr
    write:./calibration_data_bgr_f32/ILSVRC2012_val_00000100.bgr
</pre></div>
</div>
<ul class="simple">
<li><p>模型转换</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="c1">#转换时所需的配置文件mobilenet_config.yaml，已存放在03_build.sh脚本同级文件夹下</span>
    bash 03_build.sh
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明模型转换成功</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="m">2022</span>-12-07 <span class="m">18</span>:10:11,720 INFO Convert to runtime bin file sucessfully!
    <span class="m">2022</span>-12-07 <span class="m">18</span>:10:11,720 INFO End Model Convert
</pre></div>
</div>
<p>模型转换完成后，会在 <code class="docutils literal notranslate"><span class="pre">model_output</span></code> 文件夹下保存模型文件和静态性能评估文件。</p>
<ul class="simple">
<li><p>MOBILENET_subgraph_0.html        # 静态性能评估文件（可读性更好）</p></li>
<li><p>MOBILENET_subgraph_0.json        # 静态性能评估文件</p></li>
<li><p>mobilenetv1_224x224_nv12.bin     # 用于在地平线AI芯片上加载运行的模型</p></li>
<li><p>mobilenetv1_224x224_nv12_optimized_float_model.onnx # 中间过程模型文件，可用于后续模型的精度校验</p></li>
<li><p>mobilenetv1_224x224_nv12_original_float_model.onnx # 中间过程模型文件，可用于后续模型的精度校验</p></li>
<li><p>mobilenetv1_224x224_nv12_quantized_model.onnx # 中间过程模型文件，可用于后续模型的精度校验</p></li>
</ul>
</section>
<section id="id6">
<h2><span class="section-number">6.3.5. </span>模型性能验证<a class="headerlink" href="#id6" title="永久链接至标题"></a></h2>
<p>若以上模型量化步骤全部正确完成，说明示例 MobileNet-v1 模型已完成量化并已生成可在地平线X3芯片上运行的定点 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12.bin</span></code> 模型文件；若需了解 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12.bin</span></code> 定点模型的推理性能情况，请继续阅读后续内容；地平线支持在<font color=red>开发机</font>端预估模型的<font color=red>静态性能</font>，也支持在 <font color=red>开发板</font>端使用工具快速评测<font color=red>动态性能</font>。 性能验证的具体说明和性能调优建议请阅读 <a class="reference external" href="./horizon_ai_toolchain_user_guide/ptq_user_guide/chapter_model_conversion.html#performance-evaluation">模型性能分析与调优</a> 章节内容。</p>
<section id="id7">
<h3><span class="section-number">6.3.5.1. </span>静态性能评估<a class="headerlink" href="#id7" title="永久链接至标题"></a></h3>
<p>1.查看 <code class="docutils literal notranslate"><span class="pre">hb_mapper_makertbin.log</span></code> 日志文件，了解模型逐层算子的执行硬件和因CPU算子导致的分段情况。</p>
<p>2.查看 <code class="docutils literal notranslate"><span class="pre">MOBILENET_subgraph_0.html</span></code> 文件获取模型 <code class="docutils literal notranslate"><span class="pre">BPU</span></code> 部分的预估性能和模型整体带宽占用情况。</p>
</section>
<section id="id8">
<h3><span class="section-number">6.3.5.2. </span>动态性能评估<a class="headerlink" href="#id8" title="永久链接至标题"></a></h3>
<p>1.请确保已按照 <a class="reference external" href="env_install.html#id8">开发板部署</a> 章节介绍的方法完成环境部署，然后将 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12.bin</span></code> 模型拷贝至开发板的 <code class="docutils literal notranslate"><span class="pre">/userdata</span></code> 文件夹下（开发机和开发板需要网络连通）</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    scp model_output/mobilenetv1_224x224_nv12.bin root@<span class="o">{</span>board_ip<span class="o">}</span>:/userdata
</pre></div>
</div>
<p>2.登录开发板，使用 <code class="docutils literal notranslate"><span class="pre">hrt_model_exec</span> <span class="pre">perf</span></code> 工具快速评估模型的耗时和帧率</p>
<ul class="simple">
<li><p>开发板登录方法，请阅读 <a class="reference external" href="../quick_start/Login_Method.html#id1">开发板登录方法</a> 章节内容，本示例采用网口 <code class="docutils literal notranslate"><span class="pre">SSH</span></code> 登录方式：</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    ssh root@<span class="o">{</span>board_ip<span class="o">}</span>
    <span class="nb">cd</span> /userdata
</pre></div>
</div>
<ul class="simple">
<li><p>性能评测前，请执行以下命令，将开发板CPU工作状态设置为 <code class="docutils literal notranslate"><span class="pre">performance</span></code> 模式</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="nb">echo</span> performance &gt; /sys/devices/system/cpu/cpufreq/policy0/scaling_governor 
</pre></div>
</div>
<ul class="simple">
<li><p>BPU单核单线程串行状态下评测latency</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    hrt_model_exec perf --model_file mobilenetv1_224x224_nv12.bin --core_id <span class="m">1</span> --thread_num <span class="m">1</span> --frame_count <span class="m">1000</span>
</pre></div>
</div>
<p>执行命令后，会输出以下信息：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    hrt_model_exec perf --model_file mobilenetv1_224x224_nv12.bin --core_id <span class="m">1</span> --thread_num <span class="m">1</span> --frame_count <span class="m">1000</span>
    I0000 <span class="m">00</span>:00:00.000000  <span class="m">2067</span> vlog_is_on.cc:197<span class="o">]</span> RAW: Set VLOG level <span class="k">for</span> <span class="s2">&quot;*&quot;</span> to <span class="m">3</span>
    <span class="o">[</span>BPU_PLAT<span class="o">]</span>BPU Platform Version<span class="o">(</span><span class="m">1</span>.3.1<span class="o">)</span>!
    <span class="o">[</span> <span class="m">7223</span>.150130<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f080, 7f090<span class="o">)</span> PFNs busy
    <span class="o">[</span>HBRT<span class="o">]</span> <span class="nb">set</span> log level as <span class="m">0</span>. <span class="nv">version</span> <span class="o">=</span> <span class="m">3</span>.14.5
    <span class="o">[</span>DNN<span class="o">]</span> Runtime <span class="nv">version</span> <span class="o">=</span> <span class="m">1</span>.9.7_<span class="o">(</span><span class="m">3</span>.14.5 HBRT<span class="o">)</span>
    Load model to DDR cost <span class="m">128</span>.814ms.
    I0101 <span class="m">10</span>:00:23.268204  <span class="m">2067</span> main.cpp:1045<span class="o">]</span> get model handle success
    I0101 <span class="m">10</span>:00:23.268338  <span class="m">2067</span> main.cpp:1666<span class="o">]</span> get model input count success
    I0101 <span class="m">10</span>:00:23.268458  <span class="m">2067</span> main.cpp:1673<span class="o">]</span> prepare input tensor success!
    I0101 <span class="m">10</span>:00:23.268502  <span class="m">2067</span> main.cpp:1679<span class="o">]</span> get model output count success
    Frame count: <span class="m">200</span>,  Thread Average: <span class="m">3</span>.795660 ms,  thread max latency: <span class="m">4</span>.251000 ms,  thread min latency: <span class="m">3</span>.417000 ms,  FPS: <span class="m">259</span>.782776
    Frame count: <span class="m">400</span>,  Thread Average: <span class="m">3</span>.779484 ms,  thread max latency: <span class="m">4</span>.251000 ms,  thread min latency: <span class="m">3</span>.404000 ms,  FPS: <span class="m">260</span>.795807
    Frame count: <span class="m">600</span>,  Thread Average: <span class="m">3</span>.760747 ms,  thread max latency: <span class="m">4</span>.251000 ms,  thread min latency: <span class="m">3</span>.400000 ms,  FPS: <span class="m">262</span>.162018
    Frame count: <span class="m">800</span>,  Thread Average: <span class="m">3</span>.773966 ms,  thread max latency: <span class="m">4</span>.251000 ms,  thread min latency: <span class="m">3</span>.400000 ms,  FPS: <span class="m">261</span>.178772
    Frame count: <span class="m">1000</span>,  Thread Average: <span class="m">3</span>.768055 ms,  thread max latency: <span class="m">4</span>.251000 ms,  thread min latency: <span class="m">3</span>.389000 ms,  FPS: <span class="m">261</span>.604248

    Running condition:
    Thread number is: <span class="m">1</span>
    Frame count   is: <span class="m">1000</span>
    Program run time: <span class="m">3822</span>.924000 ms
    Perf result:
    Frame totally latency is: <span class="m">3768</span>.055420 ms
    Average    latency    is: <span class="m">3</span>.768055 ms
    Frame      rate       is: <span class="m">261</span>.579880 FPS
</pre></div>
</div>
<ul class="simple">
<li><p>BPU双核多线程并发状态下评测latency</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    hrt_model_exec perf --model_file mobilenetv1_224x224_nv12.bin --core_id <span class="m">0</span> --thread_num <span class="m">4</span> --frame_count <span class="m">1000</span>
</pre></div>
</div>
<p>执行命令后，会输出以下信息：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    hrt_model_exec perf --model_file mobilenetv1_224x224_nv12.bin --core_id <span class="m">0</span> --thread_num <span class="m">4</span> --frame_count <span class="m">1000</span>
    I0000 <span class="m">00</span>:00:00.000000  <span class="m">2089</span> vlog_is_on.cc:197<span class="o">]</span> RAW: Set VLOG level <span class="k">for</span> <span class="s2">&quot;*&quot;</span> to <span class="m">3</span>
    <span class="o">[</span>BPU_PLAT<span class="o">]</span>BPU Platform Version<span class="o">(</span><span class="m">1</span>.3.1<span class="o">)</span>!
    <span class="o">[</span> <span class="m">7346</span>.693719<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f070, 7f080<span class="o">)</span> PFNs busy
    <span class="o">[</span> <span class="m">7346</span>.694519<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f080, 7f090<span class="o">)</span> PFNs busy
    <span class="o">[</span> <span class="m">7346</span>.699149<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f070, 7f080<span class="o">)</span> PFNs busy
    <span class="o">[</span> <span class="m">7346</span>.700179<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f080, 7f090<span class="o">)</span> PFNs busy
    <span class="o">[</span>HBRT<span class="o">]</span> <span class="nb">set</span> log level as <span class="m">0</span>. <span class="nv">version</span> <span class="o">=</span> <span class="m">3</span>.14.5
    <span class="o">[</span>DNN<span class="o">]</span> Runtime <span class="nv">version</span> <span class="o">=</span> <span class="m">1</span>.9.7_<span class="o">(</span><span class="m">3</span>.14.5 HBRT<span class="o">)</span>
    Load model to DDR cost <span class="m">102</span>.603ms.
    I0101 <span class="m">10</span>:02:26.788780  <span class="m">2089</span> main.cpp:1045<span class="o">]</span> get model handle success
    I0101 <span class="m">10</span>:02:26.788911  <span class="m">2089</span> main.cpp:1666<span class="o">]</span> get model input count success
    I0101 <span class="m">10</span>:02:26.789034  <span class="m">2089</span> main.cpp:1673<span class="o">]</span> prepare input tensor success!
    I0101 <span class="m">10</span>:02:26.789078  <span class="m">2089</span> main.cpp:1679<span class="o">]</span> get model output count success
    Frame count: <span class="m">200</span>,  Thread Average: <span class="m">6</span>.002510 ms,  thread max latency: <span class="m">7</span>.330000 ms,  thread min latency: <span class="m">4</span>.497000 ms,  FPS: <span class="m">656</span>.142151
    Frame count: <span class="m">400</span>,  Thread Average: <span class="m">6</span>.002273 ms,  thread max latency: <span class="m">7</span>.330000 ms,  thread min latency: <span class="m">4</span>.497000 ms,  FPS: <span class="m">658</span>.308350
    Frame count: <span class="m">600</span>,  Thread Average: <span class="m">6</span>.002684 ms,  thread max latency: <span class="m">7</span>.330000 ms,  thread min latency: <span class="m">4</span>.497000 ms,  FPS: <span class="m">658</span>.937317
    Frame count: <span class="m">800</span>,  Thread Average: <span class="m">6</span>.003119 ms,  thread max latency: <span class="m">7</span>.330000 ms,  thread min latency: <span class="m">4</span>.497000 ms,  FPS: <span class="m">659</span>.245239
    Frame count: <span class="m">1000</span>,  Thread Average: <span class="m">6</span>.001638 ms,  thread max latency: <span class="m">7</span>.330000 ms,  thread min latency: <span class="m">4</span>.497000 ms,  FPS: <span class="m">659</span>.359619

    Running condition:
    Thread number is: <span class="m">4</span>
    Frame count   is: <span class="m">1000</span>
    Program run time: <span class="m">1517</span>.078000 ms
    Perf result:
    Frame totally latency is: <span class="m">6001</span>.638184 ms
    Average    latency    is: <span class="m">6</span>.001638 ms
    Frame      rate       is: <span class="m">659</span>.161889 FPS
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2><span class="section-number">6.3.6. </span>模型精度验证<a class="headerlink" href="#id9" title="永久链接至标题"></a></h2>
<p>若以上模型量化步骤全部正确完成，说明已正确获取到 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12.bin</span></code> 模型的性能情况；若需了解 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12.bin</span></code> 定点模型的推理精度情况，请继续阅读后续内容；地平线支持在<font color=red>开发机</font>端评测模型的推理精度，也支持在 <font color=red>开发板</font>端评测模型的推理精度。 精度验证的具体说明和优化建议，请阅读 <a class="reference external" href="./horizon_ai_toolchain_user_guide/ptq_user_guide/chapter_model_conversion.html#accuracy-evaluation">模型精度分析与调优</a> 章节内容。</p>
<section id="python">
<h3><span class="section-number">6.3.6.1. </span>开发机Python环境验证<a class="headerlink" href="#python" title="永久链接至标题"></a></h3>
<p>在开发机的Python环境中评测 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12_quantized_model.onnx</span></code> 模型的量化精度，其输出与 <code class="docutils literal notranslate"><span class="pre">mobilenetv1_224x224_nv12.bin</span></code> 模型是保持推理结果一致的，参考示例如下：</p>
<ul class="simple">
<li><p>测试量化模型单张图片推理结果</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    bash 04_inference.sh
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明模型推理完成</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="m">2022</span>-12-13 <span class="m">11</span>:26:57,311 INFO The input picture is classified to be:
    <span class="m">2022</span>-12-13 <span class="m">11</span>:26:57,312 INFO label <span class="m">340</span>, prob <span class="m">0</span>.98181, class <span class="o">[</span><span class="s1">&#39;zebra&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:26:57,312 INFO label <span class="m">292</span>, prob <span class="m">0</span>.01510, class <span class="o">[</span><span class="s1">&#39;tiger, Panthera tigris&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:26:57,312 INFO label <span class="m">282</span>, prob <span class="m">0</span>.00219, class <span class="o">[</span><span class="s1">&#39;tiger cat&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:26:57,312 INFO label  <span class="m">83</span>, prob <span class="m">0</span>.00050, class <span class="o">[</span><span class="s1">&#39;prairie chicken, prairie grouse, prairie fowl&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:26:57,312 INFO label <span class="m">290</span>, prob <span class="m">0</span>.00003, class <span class="o">[</span><span class="s1">&#39;jaguar, panther, Panthera onca, Felis onca&#39;</span><span class="o">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>测试浮点模型单张图片推理结果（可选）</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    bash 04_inference.sh origin
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明模型推理完成</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="m">2022</span>-12-13 <span class="m">11</span>:28:37,068 INFO The input picture is classified to be:
    <span class="m">2022</span>-12-13 <span class="m">11</span>:28:37,069 INFO label <span class="m">340</span>, prob <span class="m">0</span>.98672, class <span class="o">[</span><span class="s1">&#39;zebra&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:28:37,069 INFO label <span class="m">292</span>, prob <span class="m">0</span>.01095, class <span class="o">[</span><span class="s1">&#39;tiger, Panthera tigris&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:28:37,069 INFO label <span class="m">282</span>, prob <span class="m">0</span>.00128, class <span class="o">[</span><span class="s1">&#39;tiger cat&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:28:37,069 INFO label  <span class="m">83</span>, prob <span class="m">0</span>.00060, class <span class="o">[</span><span class="s1">&#39;prairie chicken, prairie grouse, prairie fowl&#39;</span><span class="o">]</span>
    <span class="m">2022</span>-12-13 <span class="m">11</span>:28:37,069 INFO label <span class="m">352</span>, prob <span class="m">0</span>.00003, class <span class="o">[</span><span class="s1">&#39;impala, Aepyceros melampus&#39;</span><span class="o">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>测试量化模型精度，请确保您的评测数据集已准备完成</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    bash 05_evaluate.sh
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明模型精度测评完成</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="m">2022</span>-12-13 <span class="m">12</span>:25:11,091 INFO Batch:49990/50000<span class="p">;</span> accuracy<span class="o">(</span>all<span class="o">)</span>:0.7031
    <span class="m">2022</span>-12-13 <span class="m">12</span>:25:11,091 INFO Batch:50000/50000<span class="p">;</span> accuracy<span class="o">(</span>all<span class="o">)</span>:0.7032

    <span class="o">===</span>REPORT-START<span class="o">{</span>MAPPER-EVAL<span class="o">}===</span>
    <span class="m">0</span>.7032
    <span class="o">===</span>REPORT-END<span class="o">{</span>MAPPER-EVAL<span class="o">}===</span>
</pre></div>
</div>
<ul class="simple">
<li><p>测试浮点模型精度（可选）</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    bash 05_evaluate.sh origin
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明模型精度测评完成</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="m">2022</span>-12-13 <span class="m">14</span>:07:03,226 INFO Batch:49990/50000<span class="p">;</span> accuracy<span class="o">(</span>all<span class="o">)</span>:0.7061
    <span class="m">2022</span>-12-13 <span class="m">14</span>:07:03,226 INFO Batch:50000/50000<span class="p">;</span> accuracy<span class="o">(</span>all<span class="o">)</span>:0.7062

    <span class="o">===</span>REPORT-START<span class="o">{</span>MAPPER-EVAL<span class="o">}===</span>
    <span class="m">0</span>.7062
    <span class="o">===</span>REPORT-END<span class="o">{</span>MAPPER-EVAL<span class="o">}===</span>
</pre></div>
</div>
</section>
<section id="c">
<h3><span class="section-number">6.3.6.2. </span>开发板C++环境验证<a class="headerlink" href="#c" title="永久链接至标题"></a></h3>
<p>在开发板端测评模型精度，为方便您在板端快速完成模型部署，我们为您提供了一套适配地平线X3芯片的嵌入式端预测库，并提供了相关示例。 预测库libdnn API详细内容，请阅读 <a class="reference external" href="./horizon_runtime_samples/bpu_sdk_api_doc/index.html">模型推理接口使用说明</a> 章节。 单张图片推理及常用API示例详细内容，请阅读 <a class="reference external" href="./horizon_runtime_samples/horizon_runtime_sample/index.html">模型上板运行示例说明</a> 章节。</p>
<p><strong>注意事项</strong>：进行开发板测评模型精度前，请确保已按照 <a class="reference external" href="./env_install.html">环境安装</a> 章节完成<font color=red>开发板</font>端的环境部署。</p>
<p>示例 MobileNet-v1 模型推理单张图片的板端示例运行方式如下：</p>
<ul class="simple">
<li><p>开发机环境执行交叉编译，生成可执行程序</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="nb">cd</span> ai_toolchain/horizon_runtime_sample/code
    bash build_xj3.sh
</pre></div>
</div>
<p>命令执行完毕后，若出现以下日志并无任何报错，说明编译完成</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    -- Installing: /horizon_xj3_ddk/ai_toolchain_customer/Ai_Toolchain_Package-release-v1.16.4-OE-v2.2.3a/ai_toolchain/horizon_runtime_sample/code/../xj3/script/aarch64/bin/run_resnet_feature
    -- Set runtime path of <span class="s2">&quot;/horizon_xj3_ddk/ai_toolchain_customer/Ai_Toolchain_Package-release-v1.16.4-OE-v2.2.3a/ai_toolchain/horizon_runtime_sample/code/../xj3/script/aarch64/bin/run_resnet_feature&quot;</span> to <span class="s2">&quot;&quot;</span>
    + <span class="nb">cd</span> ..
    + rm -rf arm_build
</pre></div>
</div>
<ul class="simple">
<li><p>拷贝xj3文件夹至板端</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="nb">cd</span> ../xj3/model
    mkdir runtime
    scp -r ../../xj3 root@<span class="o">{</span>board_ip<span class="o">}</span>:/userdata
</pre></div>
</div>
<ul class="simple">
<li><p>拷贝模型文件至板端</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    scp -r ../../../model_zoo/runtime/mobilenetv1 root@<span class="o">{</span>board_ip<span class="o">}</span>:/userdata/xj3/model/runtime
</pre></div>
</div>
<ul>
<li><p>登录开发板环境</p>
<p>开发板登录方法，请阅读 <a class="reference external" href="../quick_start/Login_Method.html#id1">开发板登录方法</a> 章节内容，本示例采用网口 <code class="docutils literal notranslate"><span class="pre">SSH</span></code> 登录方式；</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    ssh root@<span class="o">{</span>board_ip<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p>进入 <code class="docutils literal notranslate"><span class="pre">xj3/script/</span></code> 目录下，执行相应运行脚本即可</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="nb">cd</span> /userdata/xj3/script/00_quick_start/
    sh run_mobilenetV1.sh
</pre></div>
</div>
<p>执行命令后，会输出以下信息：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    ./aarch64/bin/run_mobileNetV1_224x224 --model_file<span class="o">=</span>../../model/runtime/mobilenetv1/mobilenetv1_224x224_nv12.bin --image_file<span class="o">=</span>../../data/cls_images/zebra_cls.jpg --top_k<span class="o">=</span><span class="m">5</span>
    I0000 <span class="m">00</span>:00:00.000000  <span class="m">1921</span> vlog_is_on.cc:197<span class="o">]</span> RAW: Set VLOG level <span class="k">for</span> <span class="s2">&quot;*&quot;</span> to <span class="m">3</span>
    <span class="o">[</span>BPU_PLAT<span class="o">]</span>BPU Platform Version<span class="o">(</span><span class="m">1</span>.3.1<span class="o">)</span>!
    <span class="o">[</span>  <span class="m">119</span>.291222<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f070, 7f080<span class="o">)</span> PFNs busy
    <span class="o">[</span>  <span class="m">119</span>.292053<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f080, 7f090<span class="o">)</span> PFNs busy
    <span class="o">[</span>  <span class="m">119</span>.296577<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f070, 7f080<span class="o">)</span> PFNs busy
    <span class="o">[</span>  <span class="m">119</span>.297422<span class="o">]</span> alloc_contig_range: <span class="o">[</span>7f080, 7f090<span class="o">)</span> PFNs busy
    <span class="o">[</span>HBRT<span class="o">]</span> <span class="nb">set</span> log level as <span class="m">0</span>. <span class="nv">version</span> <span class="o">=</span> <span class="m">3</span>.14.5
    <span class="o">[</span>DNN<span class="o">]</span> Runtime <span class="nv">version</span> <span class="o">=</span> <span class="m">1</span>.9.7_<span class="o">(</span><span class="m">3</span>.14.5 HBRT<span class="o">)</span>
    I0101 <span class="m">08</span>:01:59.387200  <span class="m">1921</span> run_mobileNetV1_224x224.cc:135<span class="o">]</span> DNN runtime version: <span class="m">1</span>.9.7_<span class="o">(</span><span class="m">3</span>.14.5 HBRT<span class="o">)</span>
    I0101 <span class="m">08</span>:01:59.387544  <span class="m">1921</span> run_mobileNetV1_224x224.cc:252<span class="o">]</span> input<span class="o">[</span><span class="m">0</span><span class="o">]</span> name is data
    I0101 <span class="m">08</span>:01:59.387662  <span class="m">1921</span> run_mobileNetV1_224x224.cc:268<span class="o">]</span> output<span class="o">[</span><span class="m">0</span><span class="o">]</span> name is prob
    I0101 <span class="m">08</span>:01:59.409677  <span class="m">1921</span> run_mobileNetV1_224x224.cc:159<span class="o">]</span> <span class="nb">read</span> image to tensor as nv12 success
    I0101 <span class="m">08</span>:01:59.413903  <span class="m">1921</span> run_mobileNetV1_224x224.cc:194<span class="o">]</span> TOP <span class="m">0</span> result id: <span class="m">340</span>
    I0101 <span class="m">08</span>:01:59.413958  <span class="m">1921</span> run_mobileNetV1_224x224.cc:194<span class="o">]</span> TOP <span class="m">1</span> result id: <span class="m">292</span>
    I0101 <span class="m">08</span>:01:59.413978  <span class="m">1921</span> run_mobileNetV1_224x224.cc:194<span class="o">]</span> TOP <span class="m">2</span> result id: <span class="m">282</span>
    I0101 <span class="m">08</span>:01:59.413995  <span class="m">1921</span> run_mobileNetV1_224x224.cc:194<span class="o">]</span> TOP <span class="m">3</span> result id: <span class="m">83</span>
    I0101 <span class="m">08</span>:01:59.414012  <span class="m">1921</span> run_mobileNetV1_224x224.cc:194<span class="o">]</span> TOP <span class="m">4</span> result id: <span class="m">290</span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h2><span class="section-number">6.3.7. </span>公版模型性能精度指标<a class="headerlink" href="#id10" title="永久链接至标题"></a></h2>
<p>下表提供了部分典型开源模型和地平线改良模型在X3M芯片上的性能精度指标。</p>
<p><img alt="model_accuracy" src="../_images/model_accuracy1.png" /></p>
<p><strong>注意</strong>：</p>
<ol>
<li><p>表格中的数据均为X3M芯片（BPU 1GHz）在开发板端实测的结果（测试模型均来自于<a class="reference external" href="./env_install.html#id3">horizon_model_convert_sample</a>模型示例包），其中：</p>
<p>a. <font color=red>耗时数据</font> 为单帧单核串行指标（芯片有两个BPU核）</p>
<p>b. <font color=red>workflow帧率</font> 为双核多线程打满，BPU/CPU 并发的指标</p>
</li>
<li><p>对于 BPU/CPU 混合异构模型，单帧串行下的耗时包括：</p>
<p><font color=red>输入量化CPU节点 + 模型BPU算子 + 模型CPU算子 + 输出反量化CPU节点 + CPU后处理</font></p>
<p>====================================================================================</p>
<p>a. 输入量化CPU节点：float32-&gt;int8，只有 featuremap 输入模型包含，图像输入模型不包含。因为需要遍历数据，所以耗时与 shape 大小成正比</p>
<p>b. 模型CPU算子：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> ⅰ. 分类模型尾部的 Softmax 和 Reshape 为 CPU 算子，耗时约 0.046ms

 ⅱ. 检测模型均没有 CPU 算子

 ⅲ. 分割模型 DeepLabV3+ 尾部的 Argmax 为 CPU 算子
</pre></div>
</div>
<p>c. 输出反量化CPU节点：int8-&gt;float32，耗时同样与 shape 大小成正比</p>
<p>d. 地平线目前支持将 <font color=red>量化/反量化节点手动摘除</font>，由用户自行融入前后处理代码中实现，以减少数据重复遍历的损耗，我们已在交付包中提供了 EfficientDet 参考示例，摘除了反量化节点合入后处理，整体性能提升明显（ <font color=red><strong>66FPS–&gt;100FPS</strong></font> ）</p>
<p>e. 目前地平线示例模型的后处理均未做针对性的性能优化，您可以根据实际需求采用如近似高效实现等优化手段进行代码级加速</p>
</li>
<li><p>在实际应用中，<font color=red>BPU 和 CPU 可以并发运行，提高整体推理速度</font>。</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="env_install.html" class="btn btn-neutral float-left" title="6.2. 环境安装" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="horizon_ai_toolchain_user_guide/index.html" class="btn btn-neutral float-right" title="6.4. 训练后量化(PTQ)使用说明" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, Horizon Robotics.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>