<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.3.15. PHY 驱动调试指南 &mdash; X3 用户手册 1.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/horizon_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/horizon.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/hobot.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="4.3.16. RTC 调试指南" href="26-RTC_Driver_Debug_Guide.html" />
    <link rel="prev" title="4.3.14. DDR压力测试方案" href="23-01-DDR_stress_test.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> X3 用户手册
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.html">1. 前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start/index.html">2. 快速入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">3. Demo使用指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">4. BSP开发指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Bsp_Develop.html">4.1. 环境搭建及编译说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../board_bring_up.html">4.2. 硬件点亮指引</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">4.3. 驱动开发指南</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1-X3J3_Platform_System_Software_Overview.html">4.3.1. 概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="0-Configure_Kernel_And_Uboot.html">4.3.2. 配置uboot和kernel选项参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="27-Uart_Driver_Debug_Guide.html">4.3.3. UART驱动调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="9-I2C_Debug_Guide_zh_CN.html">4.3.4. I2C调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="10-GPIO_Debug_Guide_zh_CN.html">4.3.5. GPIO调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="11-Pinctrl_Debug_Guide_zh_CN.html">4.3.6. Pinctrl调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="12-IO-DOMAIN_Debug_Guide_zh_CN.html">4.3.7. IO-DOMAIN调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="14-SPI_Debug_Guide_zh_CN.html">4.3.8. SPI调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="29-PWM_Driver_Debug_Guide.html">4.3.9. PWM 驱动调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="16-BPU_Driver_sysfs_Interface_zh_CN.html">4.3.10. BPU驱动sysfs调试接口</a></li>
<li class="toctree-l3"><a class="reference internal" href="17-Temperature_Sensor_Usage_zh_CN.html">4.3.11. Thermal 系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="18-Memory_Managment_zh_CN.html">4.3.12. 修改总内存大小和保留内存大小</a></li>
<li class="toctree-l3"><a class="reference internal" href="23-DDR_Debug_Guide_zh_CN.html">4.3.13. DDR故障排查指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="23-01-DDR_stress_test.html">4.3.14. DDR压力测试方案</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.3.15. PHY 驱动调试指南</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">4.3.15.1. 前言</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ethernet-phy">4.3.15.2. 地平线芯片Ethernet-PHY相关能力与约束</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ubootphy">4.3.15.3. Uboot下PHY的适配</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id2">编译配置</a></li>
<li class="toctree-l5"><a class="reference internal" href="#dts">DTS配置</a></li>
<li class="toctree-l5"><a class="reference internal" href="#pin">PIN驱动能力配置</a></li>
<li class="toctree-l5"><a class="reference internal" href="#emac">EMAC驱动源码适配方法</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id3">测试方法</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id4">常见问题</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#kernelphy">4.3.15.4. Kernel下PHY的适配</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id5">编译配置</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id6">DTS配置</a></li>
<li class="toctree-l5"><a class="reference internal" href="#pinctrl-dts">pinctrl-dts适配方法</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id7">EMAC驱动适配方法</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id8">测试方法</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id9">4.3.15.5. 常用工具介绍</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#uboot">uboot下工具</a></li>
<li class="toctree-l5"><a class="reference internal" href="#kernel">kernel下工具介绍</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="26-RTC_Driver_Debug_Guide.html">4.3.16. RTC 调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="30-WatchDog_Driver_Debug_Guide.html">4.3.17. 看门狗驱动调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="usb_develop_guide/index.html">4.3.18. USB开发调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="31-Mipi_Screen_Driver_Debug_Guide.html">4.3.19. X3 mipi 屏适配说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="33-WIFI_Driver_Debug_Guide.html">4.3.20. Wi-Fi 驱动调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="34-Bluetooth_Driver_Debug_Guide.html">4.3.21. 蓝牙驱动调试指南</a></li>
<li class="toctree-l3"><a class="reference internal" href="7-Alsa_Manual_zh_CN.html">4.3.22. ALSA使用说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="35-Auto-start.html">4.3.23. 自定义启动项</a></li>
<li class="toctree-l3"><a class="reference internal" href="36-Custom_Partition_Content.html">4.3.24. 添加自定义内容进系统镜像</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../unit_test/index.html">4.4. 硬件单元测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel_debug_guide/index.html">4.5. 内核调试指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Secure_Boot_Manual.html">4.6. 安全启动使用说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../System_OTA_Manual.html">4.7. OTA实现原理和使用方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Approved_Vendor_List/index.html">4.8. X3 Approved Vendor List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Rootfs_develop/index.html">4.9. 根文件系统制作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Low_Power_Solution_User_Guide.html">4.10. X3降功耗用户指南</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mpp_develop/index.html">5. 多媒体开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ai_toolchain_develop/index.html">6. 量化工具链开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pc_tools/index.html">7. PC工具使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQs/index.html">8. FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feedback.html">9. 建议反馈</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">X3 用户手册</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html"><span class="section-number">4. </span>BSP开发指南</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">4.3. </span>驱动开发指南</a> &raquo;</li>
      <li><span class="section-number">4.3.15. </span>PHY 驱动调试指南</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="23-01-DDR_stress_test.html" class="btn btn-neutral float-left" title="4.3.14. DDR压力测试方案" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="26-RTC_Driver_Debug_Guide.html" class="btn btn-neutral float-right" title="4.3.16. RTC 调试指南" accesskey="n">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="phy">
<h1><span class="section-number">4.3.15. </span>PHY 驱动调试指南<a class="headerlink" href="#phy" title="永久链接至标题"></a></h1>
<section id="id1">
<h2><span class="section-number">4.3.15.1. </span>前言<a class="headerlink" href="#id1" title="永久链接至标题"></a></h2>
<p>PHY（Port Physical Layer), 是一个对OSI模型实体层的共同简称。我们通常意义的以太网PHY芯片用于连接以太网MAC设备（典型的如集成了EMAC控制器的地平线征程/旭日芯片）和具体传输介质的芯片。本文以Marvell 88E1512 PHY为例，介绍地平线X3 GMAC网卡适配PHY的过程。</p>
</section>
<section id="ethernet-phy">
<h2><span class="section-number">4.3.15.2. </span>地平线芯片Ethernet-PHY相关能力与约束<a class="headerlink" href="#ethernet-phy" title="永久链接至标题"></a></h2>
<p>地平线Ethernet-PHY接口能力介绍</p>
<ul class="simple">
<li><p>支持全双工/半双工模式。</p></li>
<li><p>支持100Mbps及1000Mbps，不支持10Mbps。</p></li>
<li><p>支持RGMII、RMII类型MII数据接口，不支持其他接口类型。</p></li>
<li><p>支持MDIO接口，X3/J3/J5支持 Clause22，J5支持Clause 45。MDIO接口时钟可调（缺省2M，根据IEEE 802.3，建议时钟范围在1M-2.5之间，另外如无特殊需求不建议调整）。</p></li>
<li><p>支持1.8V电源域，不支持3.3V及其他电源域。</p></li>
<li><p>支持输出一路25MHz的EPHY_CLK作为外部PHY的参考时钟。</p></li>
<li><p>不支持clock delay，需要phy或者switch支持相关feature并开启。</p></li>
<li><p>不支持额外的复位引脚，如有需要需可以根据电路板实际情况复用其他引脚。</p></li>
<li><p>不支持phy的中断模式，只支持轮询读取phy的状态。</p></li>
</ul>
<p>电路设计checklist（系统软件相关）</p>
<ul class="simple">
<li><p>MII接口（rgmii/rmii/mdio）电平只支持1.8V电源域。</p></li>
<li><p>PHY复位引脚如果使用GPIO驱动，确保使用的PIN，复位逻辑，复位时间等与dts描述一致。</p></li>
<li><p>PHY复位引脚连接RC或其他复位电路，确保在被访问之前复位芯片处于复位完成状态。</p></li>
<li><p>地平线芯片不支持调整clock delay，所以需要PHY默认开启此功能或者提供对应的驱动开启此功能。</p></li>
</ul>
</section>
<section id="ubootphy">
<h2><span class="section-number">4.3.15.3. </span>Uboot下PHY的适配<a class="headerlink" href="#ubootphy" title="永久链接至标题"></a></h2>
<section id="id2">
<h3>编译配置<a class="headerlink" href="#id2" title="永久链接至标题"></a></h3>
<p>在uboot下，GMAC驱动会通过MDIO总线读取PHY的0x2和0x3寄存器的值，也就是PHY的ID标识，以Marvel 88E1512为例，0x2寄存器的值为0x0141,0x3寄存器的值为0x0dd0，因此88E1512的PHY ID为0x01410dd0，在uboot编译的config文件中打开marvell  PHY的编译开关以后，marvell  88E1512的PHY 驱动会在probe的时候将PHY ID注册到uboot中，X3 GMAC驱动就可以根据读取到的PHY ID识别到 88E1512。</p>
<p>打开marvell phy的编译开关</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp"># uboot/configs/xj3_soc_defconfig</span>
<span class="n">CONFIG_PHY_MARVELL</span><span class="o">=</span><span class="n">y</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="dts">
<h3>DTS配置<a class="headerlink" href="#dts" title="永久链接至标题"></a></h3>
<p>在新的项目dts中，直接引用hobot-xj3.dtsi中定义的gmac节点,然后添加对应的属性即可，例如</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">new_project</span><span class="p">.</span><span class="nl">dts</span><span class="p">:</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;hobot-xj3.dtsi&quot;</span><span class="cp"></span>
<span class="p">......</span><span class="w"></span>
<span class="o">&amp;</span><span class="n">gmac</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">phyaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0xe</span><span class="o">&gt;</span><span class="p">;</span><span class="w">          </span><span class="c1">//phy地址 当前phy地址为0xe</span>
<span class="w">        </span><span class="n">phy</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rgmii-id&quot;</span><span class="p">;</span><span class="w">    </span><span class="c1">//phy模式，如果是rmii，则填入phy-mode = &quot;rmii-id&quot;；</span>
<span class="p">};</span><span class="w"></span>
<span class="p">......</span><span class="w"></span>
</pre></div>
</div>
<p>X3/J3只支持增加PHY地址和PHY模式两种属性。
不支持在dts中指定reset gpio。
不支持fixed（接switch）模式。
phy-mode只支持”rmii-id”和”rgmii-id”两种模式，不支持其他模式。</p>
<p>由于X3 GMAC不支持配置RGMII接口上TX RX 的Timing Delay，因此需要在PHY的配置中打开TX Timing Delay和RX Timing Delay，一般在dts中将phy-mode设置为“rgmii-id”即可。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>static const char * const phy_interface_strings[] = {
		...
        [PHY_INTERFACE_MODE_RMII]               = &quot;rmii&quot;,
        [PHY_INTERFACE_MODE_RGMII]              = &quot;rgmii&quot;,
        [PHY_INTERFACE_MODE_RGMII_ID]           = &quot;rgmii-id&quot;, # rx and tx delay
        [PHY_INTERFACE_MODE_RGMII_RXID]         = &quot;rgmii-rxid&quot;, # rx delay
        [PHY_INTERFACE_MODE_RGMII_TXID]         = &quot;rgmii-txid&quot;, # rx delay
		...
};
</pre></div>
</div>
<p>如果客户使用的PHY地址和地平线参考硬件方案不一致（地平线方案PHY地址为0xe），则客户需要在
DTS中更改下phyaddr的值。</p>
</section>
<section id="pin">
<h3>PIN驱动能力配置<a class="headerlink" href="#pin" title="永久链接至标题"></a></h3>
<p>如果在缺省配置的情况下，信号电气特性或时序不满足需求，可以尝试根据实际的波形情况对相关的PIN的上下拉，驱动能力等进行配置。
X3/J3-uboot下不支持dts配置PIN驱动能力，需要根据最终的配置直接修改底层寄存器配置，具体需要修改的寄存器为（0xA600_4098-0xA600_40D0），修改寄存器的位置推荐放置在eqos_probe的入口处。具体寄存器配置见引用文件《RM-2501-5-J3 Register Reference Manual-GPIO&amp;PIN-V1.1.pdf》。</p>
</section>
<section id="emac">
<h3>EMAC驱动源码适配方法<a class="headerlink" href="#emac" title="永久链接至标题"></a></h3>
<ul class="simple">
<li><p>如果是标准PHY芯片，且电路设计参考dvb，cvb，sdb等参考设计，则一般情况下无需修改。</p></li>
<li><p>如果PHY的复位引脚使用的与参考设计不同，则建议在eqos_probe入口处完成复位逻辑。</p></li>
</ul>
<p>例如板卡使用BIFSD_DATA2作为复位引脚，PHY芯片低电平复位有效，复位时间至少持续10ms，且复位后20ms后才可访问PHY寄存器，可按照如下步骤进行进行适配：</p>
<p>1.根据引用文档《PL-2501-3-J3 PIN SW Reg-V1.1.xls》，查到BIFSD_DATA2对应的GPIO编号为GPIO[24](也就是GPIO1.8，见工作表PIN Mux List)， 对应PIN引脚功能配置寄存器为0xA600_4060</p>
<p><img alt="image-20221117105854" src="../../_images/image-20221117105854.png" /></p>
<p>2.根据引用文档《RM-2501-5-J3 Register Reference Manual-GPIO&amp;PIN-V1.1.pdf》，确认GPIO g roup 1的方向和输出值配置寄存器为0x6000_3018，其中高16bit用于配置方向，低16bit用于配置输出值。</p>
<p><img alt="image-20221117110129" src="../../_images/image-20221117110129.png" /></p>
<p>3.根据PHY芯片的要求，设计复位逻辑，例如：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">eqos_probe</span><span class="p">(</span><span class="k">struct</span> <span class="nc">udevice</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reg_val</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 设置PIN功能为GPIO</span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="mh">0xA6004060</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA6004060</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 设置GPIO1.8方向为输出</span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="mh">0xA6003018</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01000000</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA6003018</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// 复位逻辑</span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="mh">0xA6003018</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span><span class="w">    </span><span class="c1">// 拉低GPIO1.8</span>
<span class="w">    </span><span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w">               </span><span class="c1">// 拉低持续10ms</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="mh">0xA6003018</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">reg_val</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x00000100</span><span class="p">;</span><span class="w">    </span><span class="c1">// 拉高GPIO1.8</span>
<span class="w">    </span><span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span><span class="w">               </span>
<span class="w">    </span><span class="p">......</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 可正常访问PHY寄存器</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>如果板卡使用其他引脚，可以参照上述步骤实现即可。</p>
<ul class="simple">
<li><p>如果PHY芯片的自协商时间较长（超过4s），可修改宏PHY_ANEG_TIMEOUT（uboot/include/phy.h）延长超时判定时间。</p></li>
<li><p>无论在uboot阶段是否使用网卡，都需要对uboot的dts做正确的配置。</p></li>
</ul>
</section>
<section id="id3">
<h3>测试方法<a class="headerlink" href="#id3" title="永久链接至标题"></a></h3>
<p>在uboot下测试网络是否连通时，可以将X3的网口和PC电脑的网口直连，设置PC网卡为固定地址，例如：</p>
<ul class="simple">
<li><p>IP地址：192.168.1.195</p></li>
<li><p>掩码：255.255.255.0</p></li>
<li><p>网关：192.168.1.1</p></li>
</ul>
<p><img alt="image-20220309103254854" src="../../_images/image-20220309103254854.png" /></p>
<p>然后通过串口方式连接开发板，启动时按任意键进入uboot命令行，执行以下命令进行测试：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Hobot</span><span class="o">&gt;</span><span class="n">setenv</span> <span class="n">ipaddr</span> <span class="mf">192.168.1.10</span>
<span class="n">Hobot</span><span class="o">&gt;</span><span class="n">ping</span> <span class="mf">192.168.1.195</span>
</pre></div>
</div>
<p>如果打印出”host 192.168.1.195 is alive”则表示网络正常。</p>
</section>
<section id="id4">
<h3>常见问题<a class="headerlink" href="#id4" title="永久链接至标题"></a></h3>
<ul class="simple">
<li><p>EQOS_DMA_MODE_SWR stuck</p></li>
</ul>
<p>如果打印“EQOS_DMA_MODE_SWR stuck”，则表示GMAC soft  reset失败，原因是由于GMAC未能检测到PHY RX CLK的输入，此时可能是PHY未能正常复位或者PHY时钟输入异常导致PHY RX CLK 输出异常。</p>
</section>
</section>
<section id="kernelphy">
<h2><span class="section-number">4.3.15.4. </span>Kernel下PHY的适配<a class="headerlink" href="#kernelphy" title="永久链接至标题"></a></h2>
<section id="id5">
<h3>编译配置<a class="headerlink" href="#id5" title="永久链接至标题"></a></h3>
<p>在kernel下，同样需要打开对应PHY的编译选项，将PHY的驱动编译到Kernel里：</p>
<p>CONFIG_MARVELL_PHY=y</p>
<p><img alt="image-20220323121507307" src="../../_images/image-20220323121507307.png" /></p>
</section>
<section id="id6">
<h3>DTS配置<a class="headerlink" href="#id6" title="永久链接至标题"></a></h3>
<p>在新的项目dts中，直接引用hobot-xj3.dtsi中定义的gmac节点,然后添加对应的属性即可，例如：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>new_project.dts:
#include &quot;hobot-xj3.dtsi&quot;
......
&amp;ethernet {
    status = &quot;okay&quot;;

    phy-handle = &lt;&amp;phy1&gt;;
    phy-mode = &quot;rgmii-id&quot;;    //如果是rmii，此处填入phy-mode = &quot;rmii-id&quot;
    mdio {
            #address-cells = &lt;0x1&gt;;
            #size-cells = &lt;0x0&gt;;
#ifndef FIXED_PHY        
            // PHY设备     
            /* EPHY_CLK(gpio2.6) is in gpio mode and use it as RESET for PHY */
            // 复位低电平有效，如果是高电平有效，则填入“GPIO_ACTIVE_HIGH”
            // 如果phy芯片不依赖gpio，则可不填此项
            reset-gpios = &lt;&amp;gpios 38 GPIO_ACTIVE_LOW&gt;;
            /* reset pin must assert at least extra delay 50ms for MARVELL 88EA1512 */
            reset-delay-us = &lt;20000&gt;;
            /* 
                注意reset_extra_us用于描述在复位之后额外等待的时间，单位us。
                此为自定义属性，在较老版本中不支持，如果需要可以打上如下参考patch:
            */
            reset_extra_us = &lt;60000&gt;;              
            phy1: phy@e {
                    //&quot;ethernet-phy-ieee802.3-c22&quot;必填项，且不支持X3/J3不支持C45
                    compatible = &quot;marvell,88E1111&quot;,&quot;ethernet-phy-ieee802.3-c22&quot;;
                    reg = &lt;0xe&gt;;    //当前phy地址为0xe, 与phy@e一致
            };
#endif
    };
#ifdef FIXED_PHY        
    // switch 设备
    // 如果是连接一个switch设备，则可以添加如下节点：
    // 当前例子中：id为1（保证唯一即可），全双工，1000M，不支持Pause与Asym Pause
    // 参考：kernel/Documentation/devicetree/bindings/net/ethernet-controller.yaml
    fixed-link = &lt;1 1 1000 0 0&gt;;
#endif
};
</pre></div>
</div>
<p>如果当前版本的X3/J3版本不支持“reset_extra_us”属性且phy有此需要， 可参考如下patch：</p>
<p><a class="reference external" href="https://horizonrobotics.feishu.cn/file/boxcn2ix84zBgLgh0HZKDT3Gd6d">0001-ethernet-phy-fix-XJ3-4013-Fixed-ETH-PHY-initializati.patch</a></p>
</section>
<section id="pinctrl-dts">
<h3>pinctrl-dts适配方法<a class="headerlink" href="#pinctrl-dts" title="永久链接至标题"></a></h3>
<p>如果需要调整网卡相关PIN的驱动能力、上下拉等配置，可以对kernel/arch/arm64/boot/dts/hobot/hobot-pinctrl-xj3.dtsi进行必要的修改：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>pinctrl: pinctrl@0xA6004000 {
    ......
    eth_func: eth_func {
        pinctrl-single,pins = &lt;
            0x098   (MUX_F3 | DRIVE1_06MA | SCHMITT1_DIS | PULL1_DOWN)    
            0x09c   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_UP)
            0x0a0   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_UP)
            0x0a4   (MUX_F0 | DRIVE1_03MA | SCHMITT1_ENA | PULL1_DOWN)
            0x0a8   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_UP)
            0x0ac   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_UP)
            0x0b0   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_UP)
            0x0b4   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_UP)
            0x0b8   (MUX_F0 | DRIVE1_03MA | SCHMITT1_DIS | PULL1_DOWN)
            0x0bc   (MUX_F0 | DRIVE1_12MA | SCHMITT1_DIS | PULL1_DIS)
            0x0c0   (MUX_F0 | DRIVE1_12MA | SCHMITT1_DIS | PULL1_DIS)
            0x0c4   (MUX_F0 | DRIVE1_12MA | SCHMITT1_DIS | PULL1_DIS)
            0x0c8   (MUX_F0 | DRIVE1_12MA | SCHMITT1_DIS | PULL1_DIS)
            0x0cc   (MUX_F0 | DRIVE1_12MA | SCHMITT1_DIS | PULL1_DIS)
            0x0d0   (MUX_F0 | DRIVE1_12MA | SCHMITT1_DIS | PULL1_DIS)
        &gt;;
        };    
    ......
}
</pre></div>
</div>
<p>例子中依次定义如下PIN的配置：EPHY_CLK/MDCK/MDIO/RGMII_RX_CLK/RGMII_RXD0/RGMII_RXD1/RGMII_RXD2/RGMII_RXD3/RGMII_RX_DV/RGMII_TX_CLK/RGMII_TXD0/RGMII_TXD1/RGMII_TXD2/RGMII_TXD3/RGMII_TX_EN</p>
<p>DRIVE1_XXMA 属性用于配置驱动能力，可选的值为：
DRIVE1_03MA/06MA/09MA/12MA/17MA/20MA/22MA/25MA/33MA/35MA/37MA/39MA/41MA/42.5MA/44MA/45MA</p>
</section>
<section id="id7">
<h3>EMAC驱动适配方法<a class="headerlink" href="#id7" title="永久链接至标题"></a></h3>
<ul class="simple">
<li><p>MDIO速率调整方法（如无必要不建议调整）</p></li>
</ul>
<p>X3/J3芯片对于MDIO总线速率调整的部分代码位于xj3_mdio_set_csr函数中，核心是根据当前的时钟树计算分频值，并将最终的分频值保存在priv-&gt;csr_val变量中， 具体的分频计算方法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>priv-&gt;csr_val = 0 ， mdio时钟频率 = 参考时钟/42
priv-&gt;csr_val = 1 ， mdio时钟频率 = 参考时钟/62
priv-&gt;csr_val = 2 ， mdio时钟频率 = 参考时钟/16
priv-&gt;csr_val = 3 ， mdio时钟频率 = 参考时钟/26
priv-&gt;csr_val = 4 ， mdio时钟频率 = 参考时钟/102
priv-&gt;csr_val = 5 ， mdio时钟频率 = 参考时钟/124
priv-&gt;csr_val = 6 ， mdio时钟频率 = 参考时钟/204
priv-&gt;csr_val = 7 ， mdio时钟频率 = 参考时钟/324
</pre></div>
</div>
<p>当前参考时钟为250MHz，csr_val设置为5，即最终的MDIO时钟设置为250MHz/124 = 2MHz。如果需要修改，则根据上图的配置方法修改priv-&gt;csr_val值即可。</p>
<ul class="simple">
<li><p>RMII-PHY适配</p></li>
</ul>
<p>1.RMII的kernel驱动缺少对于寄存器0xA1000384的bit 0与bit 8的配置，当前采用的是uboot中配置的方法，这种方法就要求对uboot的dts正确配置。如果无法保证这一点，也可以在kernel的MAC驱动的probe函数的较晚位置设置寄存器0xA1000384。</p>
<p>2.RMII-PHY在100M模式下，需要修改xj3_set_speed函数中对于目标时钟的调整，参考修改如下：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>diff --git a/drivers/net/ethernet/hobot/hobot_eth.c b/drivers/net/ethernet/hobot/hobot_eth.c
--- a/drivers/net/ethernet/hobot/hobot_eth.c
+++ b/drivers/net/ethernet/hobot/hobot_eth.c
@@ -1175,11 +1175,11 @@ static void xj3_set_speed(struct xj3_priv *priv) {
         rate_L2 = clk_round_rate(priv-&gt;plat-&gt;xj3_mac_div_clk, target);
         clk_set_rate(priv-&gt;plat-&gt;xj3_mac_div_clk, rate_L2);
     } else if (phydev-&gt;speed == SPEED_100) {
-        target = 125000000;
+        target = 150000000;
         rate_L1 = clk_round_rate(priv-&gt;plat-&gt;xj3_mac_pre_div_clk, target);
         clk_set_rate(priv-&gt;plat-&gt;xj3_mac_pre_div_clk, rate_L1);
 
-        target = 25000000;
+        target = 50000000;
         rate_L2 = clk_round_rate(priv-&gt;plat-&gt;xj3_mac_div_clk, target);
         clk_set_rate(priv-&gt;plat-&gt;xj3_mac_div_clk, rate_L2);
</pre></div>
</div>
</section>
<section id="id8">
<h3>测试方法<a class="headerlink" href="#id8" title="永久链接至标题"></a></h3>
<p>同样地，将X3的网口和PC电脑的网口直连。</p>
<p>设置PC网卡为固定地址：</p>
<ul class="simple">
<li><p>IP地址：192.168.1.195</p></li>
<li><p>掩码：255.255.255.0</p></li>
<li><p>网关：192.168.1.1</p></li>
</ul>
<p>然后进入X3的kernel shell下，设置X3的ip地址：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">eth0</span> <span class="mf">192.168.1.10</span> <span class="n">netmask</span> <span class="mf">255.255.255.0</span>
<span class="n">route</span> <span class="n">add</span> <span class="n">default</span> <span class="n">gw</span> <span class="mf">192.168.1.1</span>
</pre></div>
</div>
<p>再执行ping命令测试网络是否连通：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ping</span> <span class="mf">192.168.1.195</span>

<span class="n">PING</span> <span class="mf">192.168.1.195</span> <span class="p">(</span><span class="mf">192.168.1.195</span><span class="p">)</span> <span class="mi">56</span><span class="p">(</span><span class="mi">84</span><span class="p">)</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="o">.</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">192.168.1.195</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">128</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.801</span> <span class="n">ms</span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2><span class="section-number">4.3.15.5. </span>常用工具介绍<a class="headerlink" href="#id9" title="永久链接至标题"></a></h2>
<section id="uboot">
<h3>uboot下工具<a class="headerlink" href="#uboot" title="永久链接至标题"></a></h3>
<ul class="simple">
<li><p>mii:主要用于读写phy的寄存器。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mii - MII utility commands

Usage:
mii device                            - list available devices    
mii device &lt;devname&gt;                  - set current device
mii info   &lt;addr&gt;                     - display MII PHY info
mii read   &lt;addr&gt; &lt;reg&gt;               - read  MII PHY &lt;addr&gt; register &lt;reg&gt;
mii write  &lt;addr&gt; &lt;reg&gt; &lt;data&gt;        - write MII PHY &lt;addr&gt; register &lt;reg&gt;
mii modify &lt;addr&gt; &lt;reg&gt; &lt;data&gt; &lt;mask&gt; - modify MII PHY &lt;addr&gt; register &lt;reg&gt;
                                        updating bits identified in &lt;mask&gt;
mii dump   &lt;addr&gt; &lt;reg&gt;               - pretty-print &lt;addr&gt; &lt;reg&gt; (0-5 only)
Addr and/or reg may be ranges, e.g. 2-7.
例如：
// 读寄存器
Hobot&gt;mii read 0xe 2
0141
// 读寄存器，并进行解析
Hobot&gt;mii dump 0xe 0
0.     (1140)                 -- PHY control register --
  (8000:0000) 0.15    =     0    reset
  (4000:0000) 0.14    =     0    loopback
  (2040:0040) 0. 6,13 =   b10    speed selection = 1000 Mbps
  (1000:1000) 0.12    =     1    A/N enable
  (0800:0000) 0.11    =     0    power-down
  (0400:0000) 0.10    =     0    isolate
  (0200:0000) 0. 9    =     0    restart A/N
  (0100:0100) 0. 8    =     1    duplex = full
  (0080:0000) 0. 7    =     0    collision test enable
  (003f:0000) 0. 5- 0 =     0    (reserved)
// 查看当前mii设备列表
Hobot# mii device
MII devices: &#39;ethernet@59110000&#39; &#39;ethernet@59120000&#39;
Current device: &#39;ethernet@59110000&#39;
// 切换mii当前使用的设备
Hobot# mii device ethernet@59120000
Hobot# mii device
MII devices: &#39;ethernet@59110000&#39; &#39;ethernet@59120000&#39;
Current device: &#39;ethernet@59120000&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>md:主要用于读内存/IO寄存器。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>md - memory display

Usage:
md [.b, .w, .l, .q] address [# of objects]
例如：

Hobot&gt;md 0xA1000000
a1000000: 01102064 00001010 00000001 00000000    d ..............
a1000010: 0120107d 00001010 00000001 00000000    }. .............
a1000020: 0130107d 00001010 00000001 00000000    }.0.............
a1000030: 01101042 00003000 00000001 00a80000    B....0..........
a1000040: 01101044 00001010 00000001 00000000    D...............
......
</pre></div>
</div>
<ul class="simple">
<li><p>mw:主要用于写内存/IO寄存器</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mw - memory write (fill)

Usage:
mw [.b, .w, .l, .q] address value [count]

例如：
Hobot&gt;mw 0x20000000 0x1
Hobot&gt;md 0x20000000
20000000: 00000001 ffffffff ffffffff ffffffff    ................
20000010: ffffffff ffffffff ffffffff ffffffff    ................
......
</pre></div>
</div>
<ul class="simple">
<li><p>ping:用于探测网络连通性。</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ping - send ICMP ECHO_REQUEST to network host

Usage:
ping pingAddress

Hobot&gt;setenv ipaddr <span class="m">192</span>.168.1.10        //需要线设置本地ip，应该为同网段的合法ip
Hobot&gt;ping <span class="m">192</span>.168.1.200
Phy name:Marvell 88E1518
Phy uid:1410dd0
ethernet@A5014000 Waiting <span class="k">for</span> PHY auto negotiation to complete....... <span class="k">done</span>
<span class="nb">set</span> <span class="nv">mac_div_clk</span> <span class="o">=</span> 125000000Using ethernet@A5014000 device
host <span class="m">192</span>.168.1.200 is alive            // 测试结果为网络通常
</pre></div>
</div>
</section>
<section id="kernel">
<h3>kernel下工具介绍<a class="headerlink" href="#kernel" title="永久链接至标题"></a></h3>
<ul class="simple">
<li><p>ethtool:网络状态查看/修改工具。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>查看当前网络link状态
root@x3dvbx3-samsung1G-3200:~# ethtool eth0
Settings for eth0:
        Supported ports: [ TP MII ]
        Supported link modes:   10baseT/Full        //当前网卡支持的能力
                                100baseT/Full
                                1000baseT/Full
        Supported pause frame use: Symmetric Receive-only
        Supports auto-negotiation: Yes            
        Supported FEC modes: Not reported
        Advertised link modes:  10baseT/Full        //广播的本方能力
                                100baseT/Full
                                1000baseT/Full
        Advertised pause frame use: No
        Advertised auto-negotiation: Yes            //自协商开启
        Advertised FEC modes: Not reported
        Link partner advertised link modes:  10baseT/Half 10baseT/Full  //对端能力
                                             100baseT/Half 100baseT/Full
                                             1000baseT/Full
        Link partner advertised pause frame use: Symmetric Receive-only
        Link partner advertised auto-negotiation: Yes
        Link partner advertised FEC modes: Not reported
        Speed: 1000Mb/s    //协商后的速率，双共，端口类型等
        Duplex: Full
        Port: MII
        PHYAD: 14            // PHY 地址为14
        Transceiver: internal
        Auto-negotiation: on
        Link detected: yes
        
// 修改网卡连接能力，比如修改为固定100M双规模式
ethtool -s eth0 autoneg off speed 100 duplex full

之后再通过ethtool读取最新的状态
root@x3dvbx3-samsung1G-3200:~# ethtool eth0
Settings for eth0:
        Supported ports: [ TP MII ]
        Supported link modes:   10baseT/Full        //网卡支持的能力
                                100baseT/Full
                                1000baseT/Full
        Supported pause frame use: Symmetric Receive-only
        Supports auto-negotiation: Yes
        Supported FEC modes: Not reported
        Advertised link modes:  100baseT/Full        //只广播100M能力
        Advertised pause frame use: No
        Advertised auto-negotiation: No              //关闭自协商
        Advertised FEC modes: Not reported
        Speed: 100Mb/s        //link状态，100M全双工
        Duplex: Full
        Port: MII
        PHYAD: 14            // PHY 地址为14
        Transceiver: internal
        Auto-negotiation: off
        Link detected: yes
</pre></div>
</div>
<ul class="simple">
<li><p>phytool:phy reg读写工具（X3/J3老版本不支持，J5支持）</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Usage</span><span class="p">:</span> <span class="n">phytool</span> <span class="n">read</span>  <span class="n">IFACE</span><span class="o">/</span><span class="n">ADDR</span><span class="o">/</span><span class="n">REG</span>
       <span class="n">phytool</span> <span class="n">write</span> <span class="n">IFACE</span><span class="o">/</span><span class="n">ADDR</span><span class="o">/</span><span class="n">REG</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">-</span><span class="mh">0xffff</span><span class="o">&gt;</span>
       <span class="n">phytool</span> <span class="nb">print</span> <span class="n">IFACE</span><span class="o">/</span><span class="n">ADDR</span><span class="p">[</span><span class="o">/</span><span class="n">REG</span><span class="p">]</span>
<span class="n">where</span>

<span class="n">ADDR</span> <span class="o">:=</span> <span class="n">C22</span> <span class="o">|</span> <span class="n">C45</span>
<span class="n">C22</span>  <span class="o">:=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">-</span><span class="mh">0x1f</span><span class="o">&gt;</span>
<span class="n">C45</span>  <span class="o">:=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">-</span><span class="mh">0x1f</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">-</span><span class="mh">0x1f</span><span class="o">&gt;</span>
<span class="n">REG</span>  <span class="o">:=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">-</span><span class="mh">0x1f</span><span class="o">&gt;</span>

<span class="n">Examples</span><span class="p">:</span>
       <span class="n">phytool</span> <span class="n">read</span>  <span class="n">eth0</span><span class="o">/</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">/</span><span class="mi">1</span>
       <span class="n">phytool</span> <span class="n">write</span> <span class="n">eth0</span><span class="o">/</span><span class="mh">0xa</span><span class="o">/</span><span class="mi">0</span> <span class="mh">0x1140</span>
       <span class="n">phytool</span> <span class="nb">print</span> <span class="n">eth0</span><span class="o">/</span><span class="mh">0x1c</span>
</pre></div>
</div>
<p>对于X3/J3，较老版本可以打上如下补丁来对phytool进行支持，也可以使用后面介绍的gmac_rw_phy.sh对phy设备进行读写访问。</p>
<p><a class="reference external" href="https://horizonrobotics.feishu.cn/file/boxcnv52oStUtzlU49NWnh82Lzb">0001-eth-phy-feat-XJ3-4413-Add-code-supported-by-the-phyt.patch</a></p>
<ul class="simple">
<li><p>gmac_rw_phy.sh（仅X3/J3）:X3/J3提供的读写PHY寄存器的工具，需要说明的时，由于kernel也一直在进行对phy的访问，所以建议使用此工具时多次操作以确认访问成功。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gmac_rw_phy.sh是X3/J3芯片提供的一个读写寄存器的脚本，其使用方法如下：
# 常用命令
# 读Phy=0xe（地址）、reg=0连续32个寄存器
# ./gmac_rw_phy.sh 0xe read_phy  0 32
#
# 写Phy=0xe（地址）、reg=1、val=0xc83d
# ./gmac_rw_phy.sh 0xe write_phy  1 0xc83d
例如：
root@x3dvbx3-samsung1G-3200:/userdata# ./gmac_rw_phy.sh 0xe read_phy 0 32
0x2100 0x2100 0x0141 0x0dd4 0x0141 0x0000 0x0004 0x2001
0x0000 0x0200 0x0000 0x0000 0x0000 0x0003 0x0000 0x3000
0x3070 0x6c08 0x0000 0x6400 0x0020 0x0000 0x0000 0x0000
0x0000 0x0000 0x0040 0x0000 0x0000 0x0000 0x0000 0x0000
</pre></div>
</div>
<p><a class="reference external" href="https://horizonrobotics.feishu.cn/file/boxcnW6hQ1ul1ZbtMRgx91vhYef">gmac_rw_phy.sh</a></p>
<ul class="simple">
<li><p>tcpdump/wireshark:wireshark是windows版本的抓包工具，功能强大使用也很简单，此处不再详述。tcpdump是linux环境工具，地平线芯片支持该工具的精简版本（部分很老的版本没有，后附文件供下载），tcpdump工具强大，但对于PHY相关功能，只需要最基本的一些选项即可，例如：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@x3dvbx3-samsung1G-3200:~# tcpdump -h
tcpdump version 4.9.2
libpcap version 1.9.1 (with TPACKET_V3)
OpenSSL 1.1.1g  21 Apr 2020
Usage: tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxX#] [ -B size ] [ -c count ]
                [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]
                [ -i interface ] [ -j tstamptype ] [ -M secret ] [ --number ]
                [ -Q in|out|inout ]
                [ -r file ] [ -s snaplen ] [ --time-stamp-precision precision ]
                [ --immediate-mode ] [ -T type ] [ --version ] [ -V file ]
                [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ]
                [ -Z user ] [ expression ]
                
//抓取eth0网口上的包                
root@x3dvbx3-samsung1G-3200:~# tcpdump -i eth0
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
08:04:33.567718 IP 192.168.1.10.ssh &gt; 192.168.1.200.51017: Flags [P.], seq 2043263027:2043263219, ack 955812216, win 315, length 192
08:04:33.572145 IP 192.168.1.10.ssh &gt; 192.168.1.200.51017: Flags [P.], seq 192:416, ack 1, win 315, length 224
08:04:33.572376 IP 192.168.1.10.ssh &gt; 192.168.1.200.51017: Flags [P.], seq 416:496, ack 1, win 315, length 80
......

//抓取eth0网口上的包并保存在t1.pcap文件中（*.pcap包可以直接在wireshark中打开）
root@x3dvbx3-samsung1G-3200:~# tcpdump -i eth0 -w /userdata/t1.pcap
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
</pre></div>
</div>
<ul class="simple">
<li><p>ifconfig:ifconfig是linux中用于显示或配置网络设备的工具，ifconfig工具较为强大，但通常在PHY相关的网络应用中只需使用最基本的选项即可，例如：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@x3dvbx3</span><span class="o">-</span><span class="n">samsung1G</span><span class="o">-</span><span class="mi">3200</span><span class="p">:</span><span class="o">/</span><span class="c1"># ifconfig -h</span>
<span class="n">Usage</span><span class="p">:</span>
  <span class="n">ifconfig</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">v</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">interface</span><span class="o">&gt;</span> <span class="p">[[</span><span class="o">&lt;</span><span class="n">AF</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]</span>
  <span class="p">[</span><span class="n">add</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">[</span><span class="o">/&lt;</span><span class="n">prefixlen</span><span class="o">&gt;</span><span class="p">]]</span>
  <span class="p">[</span><span class="k">del</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">[</span><span class="o">/&lt;</span><span class="n">prefixlen</span><span class="o">&gt;</span><span class="p">]]</span>
  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">broadcast</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]]</span>  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">pointopoint</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]]</span>
  <span class="p">[</span><span class="n">netmask</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">dstaddr</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">tunnel</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]</span>
  <span class="p">[</span><span class="n">outfill</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">keepalive</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>
  <span class="p">[</span><span class="n">hw</span> <span class="o">&lt;</span><span class="n">HW</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">metric</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">mtu</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>
  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">trailers</span><span class="p">]</span>  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">arp</span><span class="p">]</span>  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">allmulti</span><span class="p">]</span>
  <span class="p">[</span><span class="n">multicast</span><span class="p">]</span>  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">promisc</span><span class="p">]</span>
  <span class="p">[</span><span class="n">mem_start</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">io_addr</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">irq</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="n">media</span> <span class="o">&lt;</span><span class="nb">type</span><span class="o">&gt;</span><span class="p">]</span>
  <span class="p">[</span><span class="n">txqueuelen</span> <span class="o">&lt;</span><span class="n">NN</span><span class="o">&gt;</span><span class="p">]</span>
  <span class="p">[[</span><span class="o">-</span><span class="p">]</span><span class="n">dynamic</span><span class="p">]</span>
  <span class="p">[</span><span class="n">up</span><span class="o">|</span><span class="n">down</span><span class="p">]</span> <span class="o">...</span>

  <span class="o">&lt;</span><span class="n">HW</span><span class="o">&gt;=</span><span class="n">Hardware</span> <span class="n">Type</span><span class="o">.</span>
  <span class="n">List</span> <span class="n">of</span> <span class="n">possible</span> <span class="n">hardware</span> <span class="n">types</span><span class="p">:</span>
    <span class="n">loop</span> <span class="p">(</span><span class="n">Local</span> <span class="n">Loopback</span><span class="p">)</span> <span class="n">slip</span> <span class="p">(</span><span class="n">Serial</span> <span class="n">Line</span> <span class="n">IP</span><span class="p">)</span> <span class="n">cslip</span> <span class="p">(</span><span class="n">VJ</span> <span class="n">Serial</span> <span class="n">Line</span> <span class="n">IP</span><span class="p">)</span>
    <span class="n">slip6</span> <span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="n">bit</span> <span class="n">Serial</span> <span class="n">Line</span> <span class="n">IP</span><span class="p">)</span> <span class="n">cslip6</span> <span class="p">(</span><span class="n">VJ</span> <span class="mi">6</span><span class="o">-</span><span class="n">bit</span> <span class="n">Serial</span> <span class="n">Line</span> <span class="n">IP</span><span class="p">)</span> <span class="n">adaptive</span> <span class="p">(</span><span class="n">Adaptive</span> <span class="n">Serial</span> <span class="n">Line</span> <span class="n">IP</span><span class="p">)</span>
    <span class="n">ether</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span> <span class="n">netrom</span> <span class="p">(</span><span class="n">AMPR</span> <span class="n">NET</span><span class="o">/</span><span class="n">ROM</span><span class="p">)</span> <span class="n">tunnel</span> <span class="p">(</span><span class="n">IPIP</span> <span class="n">Tunnel</span><span class="p">)</span>
    <span class="n">ppp</span> <span class="p">(</span><span class="n">Point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">Point</span> <span class="n">Protocol</span><span class="p">)</span> <span class="n">arcnet</span> <span class="p">(</span><span class="n">ARCnet</span><span class="p">)</span> <span class="n">dlci</span> <span class="p">(</span><span class="n">Frame</span> <span class="n">Relay</span> <span class="n">DLCI</span><span class="p">)</span>
    <span class="n">frad</span> <span class="p">(</span><span class="n">Frame</span> <span class="n">Relay</span> <span class="n">Access</span> <span class="n">Device</span><span class="p">)</span> <span class="n">irda</span> <span class="p">(</span><span class="n">IrLAP</span><span class="p">)</span>
  <span class="o">&lt;</span><span class="n">AF</span><span class="o">&gt;=</span><span class="n">Address</span> <span class="n">family</span><span class="o">.</span> <span class="n">Default</span><span class="p">:</span> <span class="n">inet</span>
  <span class="n">List</span> <span class="n">of</span> <span class="n">possible</span> <span class="n">address</span> <span class="n">families</span><span class="p">:</span>
    <span class="n">unix</span> <span class="p">(</span><span class="n">UNIX</span> <span class="n">Domain</span><span class="p">)</span> <span class="n">inet</span> <span class="p">(</span><span class="n">DARPA</span> <span class="n">Internet</span><span class="p">)</span> <span class="n">inet6</span> <span class="p">(</span><span class="n">IPv6</span><span class="p">)</span>
    <span class="n">netrom</span> <span class="p">(</span><span class="n">AMPR</span> <span class="n">NET</span><span class="o">/</span><span class="n">ROM</span><span class="p">)</span>
    
<span class="o">//</span> <span class="n">查看网卡状态</span>
<span class="n">root</span><span class="nd">@x3dvbx3</span><span class="o">-</span><span class="n">samsung1G</span><span class="o">-</span><span class="mi">3200</span><span class="p">:</span><span class="o">/</span><span class="c1"># ifconfig eth0</span>
<span class="n">eth0</span>      <span class="n">Link</span> <span class="n">encap</span><span class="p">:</span><span class="n">Ethernet</span>  <span class="n">HWaddr</span> <span class="mi">00</span><span class="p">:</span><span class="mi">61</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">9</span><span class="n">f</span><span class="p">:</span><span class="n">b9</span>
          <span class="n">inet</span> <span class="n">addr</span><span class="p">:</span><span class="mf">192.168.1.10</span>  <span class="n">Bcast</span><span class="p">:</span><span class="mf">192.168.1.255</span>  <span class="n">Mask</span><span class="p">:</span><span class="mf">255.255.255.0</span>
          <span class="n">inet6</span> <span class="n">addr</span><span class="p">:</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">261</span><span class="p">:</span><span class="mi">7</span><span class="n">dff</span><span class="p">:</span><span class="n">fe31</span><span class="p">:</span><span class="mi">9</span><span class="n">fb9</span><span class="o">/</span><span class="mi">64</span> <span class="n">Scope</span><span class="p">:</span><span class="n">Link</span>
          <span class="n">UP</span> <span class="n">BROADCAST</span> <span class="n">RUNNING</span> <span class="n">MULTICAST</span>  <span class="n">MTU</span><span class="p">:</span><span class="mi">1500</span>  <span class="n">Metric</span><span class="p">:</span><span class="mi">1</span>
          <span class="n">RX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">191166</span> <span class="n">errors</span><span class="p">:</span><span class="mi">0</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">1</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">0</span> <span class="n">frame</span><span class="p">:</span><span class="mi">0</span><span class="o">//</span><span class="n">统计数据</span>
          <span class="n">TX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">313229</span> <span class="n">errors</span><span class="p">:</span><span class="mi">0</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">0</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">0</span> <span class="n">carrier</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">collisions</span><span class="p">:</span><span class="mi">0</span> <span class="n">txqueuelen</span><span class="p">:</span><span class="mi">1000</span>
          <span class="n">RX</span> <span class="nb">bytes</span><span class="p">:</span><span class="mi">12269756</span> <span class="p">(</span><span class="mf">11.7</span> <span class="n">MiB</span><span class="p">)</span>  <span class="n">TX</span> <span class="nb">bytes</span><span class="p">:</span><span class="mi">44393384</span> <span class="p">(</span><span class="mf">42.3</span> <span class="n">MiB</span><span class="p">)</span>
          <span class="n">Interrupt</span><span class="p">:</span><span class="mi">43</span> <span class="n">Base</span> <span class="n">address</span><span class="p">:</span><span class="mh">0xa000</span>

<span class="o">//</span> <span class="n">修改网卡ip地址为192</span><span class="mf">.168.1.100</span> <span class="n">子网掩码</span> <span class="mf">255.255.255.0</span>
<span class="n">root</span><span class="nd">@x3dvbx3</span><span class="o">-</span><span class="n">samsung1G</span><span class="o">-</span><span class="mi">3200</span><span class="p">:</span><span class="o">/</span><span class="c1"># ifconfig eth0 192.168.1.100 netmask 255.255.255.0</span>
<span class="n">root</span><span class="nd">@x3dvbx3</span><span class="o">-</span><span class="n">samsung1G</span><span class="o">-</span><span class="mi">3200</span><span class="p">:</span><span class="o">/</span><span class="c1"># ifconfig eth0</span>
<span class="n">eth0</span>      <span class="n">Link</span> <span class="n">encap</span><span class="p">:</span><span class="n">Ethernet</span>  <span class="n">HWaddr</span> <span class="mi">00</span><span class="p">:</span><span class="mi">61</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">9</span><span class="n">f</span><span class="p">:</span><span class="n">b9</span>
          <span class="n">inet</span> <span class="n">addr</span><span class="p">:</span><span class="mf">192.168.1.100</span>  <span class="n">Bcast</span><span class="p">:</span><span class="mf">192.168.1.255</span>  <span class="n">Mask</span><span class="p">:</span><span class="mf">255.255.255.0</span>
          <span class="n">inet6</span> <span class="n">addr</span><span class="p">:</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">261</span><span class="p">:</span><span class="mi">7</span><span class="n">dff</span><span class="p">:</span><span class="n">fe31</span><span class="p">:</span><span class="mi">9</span><span class="n">fb9</span><span class="o">/</span><span class="mi">64</span> <span class="n">Scope</span><span class="p">:</span><span class="n">Link</span>
          <span class="n">UP</span> <span class="n">BROADCAST</span> <span class="n">RUNNING</span> <span class="n">MULTICAST</span>  <span class="n">MTU</span><span class="p">:</span><span class="mi">1500</span>  <span class="n">Metric</span><span class="p">:</span><span class="mi">1</span>
          <span class="n">RX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">191225</span> <span class="n">errors</span><span class="p">:</span><span class="mi">0</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">1</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">0</span> <span class="n">frame</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">TX</span> <span class="n">packets</span><span class="p">:</span><span class="mi">313259</span> <span class="n">errors</span><span class="p">:</span><span class="mi">0</span> <span class="n">dropped</span><span class="p">:</span><span class="mi">0</span> <span class="n">overruns</span><span class="p">:</span><span class="mi">0</span> <span class="n">carrier</span><span class="p">:</span><span class="mi">0</span>
          <span class="n">collisions</span><span class="p">:</span><span class="mi">0</span> <span class="n">txqueuelen</span><span class="p">:</span><span class="mi">1000</span>
          <span class="n">RX</span> <span class="nb">bytes</span><span class="p">:</span><span class="mi">12273296</span> <span class="p">(</span><span class="mf">11.7</span> <span class="n">MiB</span><span class="p">)</span>  <span class="n">TX</span> <span class="nb">bytes</span><span class="p">:</span><span class="mi">44398076</span> <span class="p">(</span><span class="mf">42.3</span> <span class="n">MiB</span><span class="p">)</span>
          <span class="n">Interrupt</span><span class="p">:</span><span class="mi">43</span> <span class="n">Base</span> <span class="n">address</span><span class="p">:</span><span class="mh">0xa000</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="23-01-DDR_stress_test.html" class="btn btn-neutral float-left" title="4.3.14. DDR压力测试方案" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="26-RTC_Driver_Debug_Guide.html" class="btn btn-neutral float-right" title="4.3.16. RTC 调试指南" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, Horizon Robotics.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>